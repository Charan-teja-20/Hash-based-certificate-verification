<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Certificate DApp with IPFS</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --dark-bg: #1a0f35;
            --primary-glow: #00a2ff;
            --secondary-glow: #f008b7;
            --accent-glow: #f7ff00;
            --text-color: #f0f8ff;
            --glass-bg: rgba(40, 26, 87, 0.6);
            --glass-border: rgba(0, 162, 255, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            background-color: var(--dark-bg);
            overflow-x: hidden;
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        h1 {
            font-size: 42px;
            font-weight: 700;
            text-shadow: 0 0 10px var(--primary-glow), 0 0 20px var(--secondary-glow);
            animation: fadeInDown 1s ease-out;
        }

        .container {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            width: 90%;
            max-width: 850px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: slideInUp 1s 0.3s ease-out forwards;
            opacity: 0;
        }
        
        button, .button-style {
            width: 100%;
            margin: 8px 0;
            padding: 16px;
            border: 1px solid var(--primary-glow);
            border-radius: 12px;
            font-size: 18px;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(0, 162, 255, 0.3), inset 0 0 5px rgba(0, 162, 255, 0.2);
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        button:hover:not(:disabled), .button-style:hover {
            background-color: var(--primary-glow);
            color: var(--dark-bg);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            border-color: grey;
            color: grey;
            box-shadow: none;
        }

        #connectButton {
             border-color: var(--accent-glow);
             box-shadow: 0 0 10px rgba(247, 255, 0, 0.3), inset 0 0 5px rgba(247, 255, 0, 0.2);
             animation: pulseGlow 2.5s infinite alternate;
        }
        #connectButton:hover {
            background-color: var(--accent-glow);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        @keyframes pulseGlow {
            from { box-shadow: 0 0 10px rgba(247, 255, 0, 0.3), inset 0 0 5px rgba(247, 255, 0, 0.2); }
            to { box-shadow: 0 0 20px rgba(247, 255, 0, 0.6), inset 0 0 10px rgba(247, 255, 0, 0.3); }
        }

        .tab-buttons { display: flex; border-bottom: 1px solid var(--glass-border); margin-bottom: 20px; }
        .tab-button {
            flex: 1; padding: 15px; background: none; color: var(--text-color);
            font-size: 16px; border: none; cursor: pointer; transition: all 0.3s;
            border-radius: 10px 10px 0 0; position: relative; font-weight: 600;
        }
        .tab-button::after {
            content: ''; position: absolute; bottom: -1px; left: 0;
            width: 100%; height: 3px; background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow));
            transform: scaleX(0); transition: transform 0.3s ease;
        }
        .tab-button.active, .tab-button:hover {
            color: var(--primary-glow);
        }
        .tab-button.active::after { transform: scaleX(1); }
        #admin-tab { display: none; } /* Hidden by default */

        .tab-content { display: none; animation: fadeIn 0.6s ease; }
        .tab-content.active { display: block; }

        input[type="file"], input[type="text"], input[type="number"] {
            margin: 10px 0; padding: 14px; width: calc(100% - 28px);
            border-radius: 10px; border: 1px solid var(--glass-border); font-size: 16px;
            background: rgba(0,0,0,0.3); color: var(--text-color);
            transition: all 0.3s;
        }
        input:focus {
            box-shadow: 0 0 8px var(--primary-glow);
            border-color: var(--primary-glow);
            outline: none;
        }
        
        #verificationResult, #myCertsList, #batch-table-container { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; margin-top: 20px; text-align: left; }
        .cert-item { border-bottom: 1px solid var(--glass-border); padding: 10px; line-height: 1.6; display: block; }
        .cert-item-hash { font-family: 'SF Mono', 'Courier New', monospace; font-size: 12px; word-break: break-all; opacity: 0.7; }
        .ens-name { font-weight: bold; color: var(--primary-glow); }

        #batch-table { width: 100%; border-collapse: collapse; }
        #batch-table th, #batch-table td { padding: 10px; border: 1px solid var(--glass-border); }
        #batch-table th { background-color: rgba(0, 162, 255, 0.2); font-weight: 600; }
        .remove-btn { background: rgba(240, 8, 183, 0.3); color: #f008b7; border: 1px solid #f008b7; padding: 5px 10px; font-size: 14px; width: auto; margin: 0; }
        
        #notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: var(--glass-bg); backdrop-filter: blur(5px); border: 1px solid var(--glass-border); color: white; padding: 16px; border-radius: 8px; z-index: 1000; transition: top 0.5s ease-in-out; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-weight: 600; }
        #notification.error { border-color: #f008b7; text-shadow: 0 0 5px #f008b7; }

        .qr-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--glass-border); display: none; text-align: center; animation: fadeIn 0.5s; }
        #qrCanvas { background: white; padding: 10px; border-radius: 10px; display: inline-block;}
        .qr-button-group button { width: auto; display: inline-block; padding: 8px 15px; font-size: 14px; margin: 5px;}

        /* General Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <h1>Advanced Certificate DApp</h1>
    <button id="connectButton">üîó Connect Wallet</button>
    <div id="status" style="margin: 10px 0; font-weight: bold; opacity: 0.9;">üîå Wallet not connected</div>
    <div id="notification"></div>

    <div class="container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('issue')">Issue Single</button>
            <button class="tab-button" onclick="showTab('batch')">Issue Batch</button>
            <button class="tab-button" onclick="showTab('verify')">Verify</button>
            <button class="tab-button" onclick="showTab('history')">My History</button>
            <button id="admin-tab" class="tab-button" onclick="showTab('admin')">Admin Panel</button>
        </div>

        <div id="issue" class="tab-content active">
            <h2>Issue a New Certificate</h2>
            <input type="file" id="fileInput" accept=".pdf, .png, .jpg, .jpeg" onchange="generateHash()" />
            <input type="text" id="hashInput" placeholder="Hash (auto-generated from file)" readonly />
            <input type="text" id="recipientName" placeholder="Recipient's Name" />
            <input type="text" id="courseTitle" placeholder="Course or Achievement" />
            <input type="number" id="grade" placeholder="Grade / Score (0-100)" min="0" max="100"/>
            <button id="issueCertBtn" onclick="issueCert()">‚ú® Issue Certificate</button>
        </div>

        <div id="batch" class="tab-content">
             <h2>Batch Issue Certificates</h2>
             <p>Manually add entries or upload a CSV file with headers: hash, recipientName, courseTitle, grade</p>
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="batchRecipientName" placeholder="Recipient's Name"/>
                <input type="text" id="batchCourseTitle" placeholder="Course Title"/>
                <input type="text" id="batchHash" placeholder="Certificate Hash"/>
                <input type="number" id="batchGrade" placeholder="Grade"/>
             </div>
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="addToBatch()">‚ûï Add Entry Manually</button>
                <label for="csvFileInput" class="button-style">üßæ Upload CSV File</label>
                <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileUpload(event)" style="display:none;" />
             </div>
             <div id="batch-table-container">
                <table id="batch-table"><thead><tr><th>Recipient</th><th>Course</th><th>Hash</th><th>Grade</th><th>Action</th></tr></thead><tbody></tbody></table>
             </div>
             <button id="issueBatchBtn" onclick="issueBatch()" style="margin-top: 20px;">üöÄ Issue Entire Batch</button>
        </div>
        
        <div id="verify" class="tab-content">
            <h2>Verify a Certificate</h2>
            <input type="text" id="verifyHashInput" placeholder="Enter Certificate Hash to Verify" />
            <button onclick="verifyCert()">üîç Verify Certificate</button>
            <div id="verificationResult"></div>
            <div class="qr-section" id="qrSection">
                <canvas id="qrCanvas"></canvas>
                <div class="qr-button-group">
                    <button onclick="copyLink()">üìã Copy Link</button>
                    <button onclick="downloadQR()">‚¨áÔ∏è Download QR</button>
                    <button onclick="shareQR()">üì§ Share QR</button>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <h2>My Issued Certificates</h2>
            <input type="text" id="historySearch" onkeyup="filterHistory()" placeholder="üîç Search by recipient or course..."/>
            <button onclick="fetchIssuedCertificates()">üîÑ Refresh History</button>
            <div id="myCertsList">Your issued certificates will appear here...</div>
        </div>

        <div id="admin" class="tab-content">
            <h2>Owner Admin Panel</h2>
            <p>Grant or revoke the ability for an address to issue certificates.</p>
            <input type="text" id="issuerAddress" placeholder="Enter address (e.g., 0x...)" />
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button id="grantRoleBtn" onclick="grantRole()">Grant Issuer Role</button>
                <button id="revokeRoleBtn" onclick="revokeRole()" style="background: rgba(240, 8, 183, 0.3); color: #f008b7; border-color: #f008b7;">Revoke Issuer Role</button>
            </div>
        </div>
    </div>

    <script>
        let web3, account, contract, contractOwner;
        let batchToIssue = [];

        // ==================================================================
        // === CRITICAL STEP 1: REPLACE THIS WITH YOUR DEPLOYED CONTRACT ADDRESS ===
        // ==================================================================
        const contractAddress = "0x94D68c1DBC0D256acbbca89ECac6ab45E4Aa7Da5";
        
        // ==================================================================
        // === CRITICAL STEP 2: REPLACE WITH YOUR PINATA JWT (SECRET ACCESS TOKEN) ===
        // ==================================================================
        const pinataJwt = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiIyYzg0YjA4My1mZDFlLTRjMzMtYjFlMi0zNGNiNGNmMWMyMTMiLCJlbWFpbCI6ImNoZXJyeS42MzA1N0BnbWFpbC5jb20iLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwicGluX3BvbGljeSI6eyJyZWdpb25zIjpbeyJkZXNpcmVkUmVwbGljYXRpb25Db3VudCI6MSwiaWQiOiJGUkExIn0seyJkZXNpcmVkUmVwbGljYXRpb25Db3VudCI6MSwiaWQiOiJOWUMxIn1dLCJ2ZXJzaW9uIjoxfSwibWZhX2VuYWJsZWQiOmZhbHNlLCJzdGF0dXMiOiJBQ1RJVkUifSwiYXV0aGVudGljYXRpb25UeXBlIjoic2NvcGVkS2V5Iiwic2NvcGVkS2V5S2V5IjoiZDgyZmE2OTUyNTc0Y2ZkZmEzNTkiLCJzY29wZWRLZXlTZWNyZXQiOiI3NmIxOGRiNDY5ZmJkY2ZmY2I1ZjMzMzk0N2Q3OGNkMTNjNzQzMGY3MmU1NTg4NWQyMWIxOTdjYjk4N2ZiOTA5IiwiZXhwIjoxNzg2NzY2MzI3fQ.5ljGVpbw_ILhVxNrUjMPWXzD_UcIXkY7KVHkiqQC6_E';
        
        // Remember to use the ABI from your updated contract with the 'ipfsCid' field
        const abi = [[
	{
		"inputs": [
			{
				"internalType": "bytes32[]",
				"name": "certHashes",
				"type": "bytes32[]"
			},
			{
				"internalType": "string[]",
				"name": "recipientNames",
				"type": "string[]"
			},
			{
				"internalType": "string[]",
				"name": "courseTitles",
				"type": "string[]"
			},
			{
				"internalType": "uint8[]",
				"name": "grades",
				"type": "uint8[]"
			},
			{
				"internalType": "string[]",
				"name": "_ipfsCids",
				"type": "string[]"
			}
		],
		"name": "batchIssueCertificates",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "recipientName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "courseTitle",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "ipfsCid",
				"type": "string"
			}
		],
		"name": "CertificateIssued",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			}
		],
		"name": "CertificateRevoked",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_account",
				"type": "address"
			}
		],
		"name": "grantIssuerRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			},
			{
				"internalType": "string",
				"name": "recipientName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "courseTitle",
				"type": "string"
			},
			{
				"internalType": "uint8",
				"name": "grade",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "_ipfsCid",
				"type": "string"
			}
		],
		"name": "issueCertificate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "IssuerGranted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "IssuerRevoked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			}
		],
		"name": "revokeCertificate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_account",
				"type": "address"
			}
		],
		"name": "revokeIssuerRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			}
		],
		"name": "getCertificateDetails",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "issuer",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "issueDate",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "isValid",
						"type": "bool"
					},
					{
						"internalType": "string",
						"name": "recipientName",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "courseTitle",
						"type": "string"
					},
					{
						"internalType": "uint8",
						"name": "grade",
						"type": "uint8"
					},
					{
						"internalType": "string",
						"name": "ipfsCid",
						"type": "string"
					}
				],
				"internalType": "struct CertificateRegistryV2.Certificate",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_issuer",
				"type": "address"
			}
		],
		"name": "getCertificatesByIssuer",
		"outputs": [
			{
				"internalType": "bytes32[]",
				"name": "",
				"type": "bytes32[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isIssuer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]];

        // --- Helper function for transaction feedback ---
        function setButtonProcessing(buttonId, isProcessing) {
            const button = document.getElementById(buttonId);
            if(!button) return;
            if (isProcessing) {
                button.disabled = true;
                button.textContent = '‚è≥ Processing...';
            } else {
                button.disabled = false;
                const originalTexts = {
                    issueCertBtn: '‚ú® Issue Certificate',
                    issueBatchBtn: 'üöÄ Issue Entire Batch',
                    grantRoleBtn: 'Grant Issuer Role',
                    revokeRoleBtn: 'Revoke Issuer Role'
                };
                button.textContent = originalTexts[buttonId];
            }
        }

        async function connectWallet() {
            if (!window.ethereum) return showNotification("Please install MetaMask to use this DApp.", true);
            try {
                web3 = new Web3(window.ethereum);
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = accounts[0];
                contract = new web3.eth.Contract(abi, contractAddress);
                const connectedAddressDisplay = await getEnsName(account);
                document.getElementById("connectButton").innerText = "‚úÖ Wallet Connected";
                document.getElementById("status").innerHTML = `üü¢ Connected: ${connectedAddressDisplay}`;
                await checkUserRole();
                await fetchIssuedCertificates();
            } catch (e) {
                showNotification("Connection failed: " + e.message, true);
            }
        }
        
        async function getEnsName(address) {
            // This functionality is often provider-specific and might not be available on all testnets.
            // For it to work, your connected wallet's network must support ENS reverse resolution.
            // It might require ethers.js for more robust support, but this is a web3.js attempt.
            return address; // Placeholder for simplicity. A full implementation is more complex.
        }

        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const certs = document.querySelectorAll('#myCertsList .cert-item');
            certs.forEach(cert => {
                const p = cert.querySelector('p[data-recipient]');
                const recipient = p.dataset.recipient.toLowerCase();
                const course = p.dataset.course.toLowerCase();
                if (recipient.includes(searchTerm) || course.includes(searchTerm)) {
                    cert.style.display = 'block';
                } else {
                    cert.style.display = 'none';
                }
            });
        }
        
        // Paste the rest of the JavaScript functions from the previous version here...
        // (showTab, checkUserRole, issueCert, batch functions, verifyCert, IPFS, CSV, QR, etc.)

        async function uploadToIPFS(file) {
            if (!pinataJwt || pinataJwt === 'YOUR_PINATA_JWT') {
                showNotification("Pinata API Key (JWT) is not set.", true);
                return null;
            }
            showNotification("üõ∞Ô∏è Uploading file to IPFS via Pinata...");
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
                    method: "POST",
                    headers: { Authorization: `Bearer ${pinataJwt}` },
                    body: formData,
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const resData = await response.json();
                showNotification("‚úÖ File pinned to IPFS successfully!");
                return resData.IpfsHash;
            } catch (error) {
                console.error('IPFS Upload Error:', error);
                showNotification(`‚ùå IPFS Upload Error: ${error.message}`, true);
                return null;
            }
        }

        async function issueCert() {
            if (!contract) return showNotification("Please connect wallet.", true);
            const file = document.getElementById("fileInput").files[0];
            if (!file) return showNotification("Please select a certificate file first.", true);
            setButtonProcessing('issueCertBtn', true);
            const ipfsCid = await uploadToIPFS(file);
            if (!ipfsCid) {
                setButtonProcessing('issueCertBtn', false);
                return;
            }
            const hash = document.getElementById("hashInput").value;
            const recipientName = document.getElementById("recipientName").value;
            const courseTitle = document.getElementById("courseTitle").value;
            const grade = document.getElementById("grade").value;
            if (!hash || !recipientName || !courseTitle || grade === '') {
                setButtonProcessing('issueCertBtn', false);
                return showNotification("Please fill all other fields.", true);
            }
            showNotification("üöÄ Sending transaction to issue certificate...");
            try {
                await contract.methods.issueCertificate(hash, recipientName, courseTitle, grade, ipfsCid).send({ from: account });
                showNotification("‚ú® Certificate permanently recorded on-chain!");
                fetchIssuedCertificates();
            } catch (e) {
                showNotification("‚ùå Transaction Error: " + e.message, true);
            } finally {
                setButtonProcessing('issueCertBtn', false);
            }
        }

        async function verifyCert() {
            if (!contract) return showNotification("Please connect wallet.", true);
            const hash = document.getElementById("verifyHashInput").value;
            if (!hash) return showNotification("Please enter a hash to verify.", true);
            const resultDiv = document.getElementById("verificationResult");
            const qrSection = document.getElementById('qrSection');
            resultDiv.style.display = 'none';
            qrSection.style.display = 'none';
            try {
                const certDetails = await contract.methods.getCertificateDetails(hash).call();
                const issuerDisplay = await getEnsName(certDetails.issuer);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h3 style="color: ${certDetails.isValid ? 'var(--primary-glow)' : 'var(--secondary-glow)'}; text-shadow: 0 0 5px ${certDetails.isValid ? 'var(--primary-glow)' : 'var(--secondary-glow)'};">
                        ${certDetails.isValid ? '‚úÖ VALID CERTIFICATE' : '‚ùå CERTIFICATE REVOKED'}
                    </h3>
                    <p><strong>Recipient:</strong> ${certDetails.recipientName}</p>
                    <p><strong>Achievement:</strong> ${certDetails.courseTitle}</p>
                    <p><strong>Grade/Score:</strong> ${certDetails.grade}</p>
                    <p><strong>Issued By:</strong> <span class="cert-item-hash">${issuerDisplay}</span></p>
                    <p><strong>Issue Date:</strong> ${new Date(Number(certDetails.issueDate) * 1000).toLocaleString()}</p>
                    <p><strong>Permanent File Link:</strong> <a href="https://ipfs.io/ipfs/${certDetails.ipfsCid}" target="_blank" style="color: var(--primary-glow); font-weight: bold;">View on IPFS</a></p>
                `;
                generateQRCode(hash);
                qrSection.style.display = 'block';
            } catch (e) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<h3 style="color: var(--accent-glow);">‚ö†Ô∏è NOT FOUND</h3><p>This certificate hash does not exist in the registry.</p>`;
            }
        }

        // --- All other JS functions go here ---
        function showTab(tabName) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); document.getElementById(tabName).classList.add('active'); document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active'); }
        async function checkUserRole() { if (!contract) return; try { contractOwner = await contract.methods.owner().call(); const isAdmin = account.toLowerCase() === contractOwner.toLowerCase(); document.getElementById('admin-tab').style.display = isAdmin ? 'block' : 'none'; } catch (e) { console.error("Could not check user role:", e.message); } }
        function showNotification(message, isError = false) { const n = document.getElementById('notification'); n.textContent = message; n.className = isError ? 'error' : ''; n.style.top = '20px'; setTimeout(() => { n.style.top = '-100px'; }, 5000); }
        async function generateHash() { const fi = document.getElementById("fileInput"); if (fi.files.length === 0) return; const f = fi.files[0]; showNotification("Hashing file..."); const ab = await f.arrayBuffer(); const hb = await crypto.subtle.digest("SHA-256", ab); const ha = Array.from(new Uint8Array(hb)); const hh = "0x" + ha.map(b => b.toString(16).padStart(2, "0")).join(""); document.getElementById("hashInput").value = hh; showNotification("üìÑ Hash generated successfully!", false); }
        function addToBatch() { const rn = document.getElementById("batchRecipientName").value; const ct = document.getElementById("batchCourseTitle").value; const h = document.getElementById("batchHash").value; const g = document.getElementById("batchGrade").value; if (!rn || !ct || !h || g === '') return showNotification("Please fill all fields for the batch item.", true); batchToIssue.push({ recipientName: rn, courseTitle: ct, hash: h, grade: g }); renderBatchTable(); document.getElementById("batchRecipientName").value = ''; document.getElementById("batchCourseTitle").value = ''; document.getElementById("batchHash").value = ''; document.getElementById("batchGrade").value = ''; }
        function renderBatchTable() { const tb = document.querySelector("#batch-table tbody"); tb.innerHTML = ""; batchToIssue.forEach((item, index) => { const row = tb.insertRow(); row.innerHTML = `<td>${item.recipientName}</td><td>${item.courseTitle}</td><td style="font-size:10px; word-break:break-all;">${item.hash.substring(0,10)}...</td><td>${item.grade}</td><td><button class="remove-btn" onclick="removeFromBatch(${index})">X</button></td>`; }); }
        function removeFromBatch(index) { batchToIssue.splice(index, 1); renderBatchTable(); }
        async function issueBatch() { if (batchToIssue.length === 0) return showNotification("Batch is empty.", true); showNotification("This feature requires a CSV with an 'ipfsCid' column for each file. Manual file uploads for each row are not yet supported in this UI.", true); }
        async function fetchIssuedCertificates() { if (!contract) return; const ld = document.getElementById('myCertsList'); ld.innerHTML = "<em>Loading...</em>"; try { const ch = await contract.methods.getCertificatesByIssuer(account).call(); if (ch.length === 0) { ld.innerHTML = "You have not issued any certificates yet."; return; } ld.innerHTML = ""; for (const h of ch.reverse()) { const cd = await contract.methods.getCertificateDetails(h).call(); const item = document.createElement("div"); item.className = "cert-item"; item.innerHTML = `<p data-recipient="${cd.recipientName}" data-course="${cd.courseTitle}"><strong>Recipient:</strong> ${cd.recipientName} | <strong>Course:</strong> ${cd.courseTitle}</p><p><strong>Status:</strong> ${cd.isValid ? `<span style='color:var(--primary-glow);'>Valid</span>` : `<span style='color:var(--secondary-glow);'>Revoked</span>`}</p>`; ld.appendChild(item); } } catch (e) { showNotification("Could not fetch history: " + e.message, true); } }
        async function grantRole() { if (!contract) return; const addr = document.getElementById('issuerAddress').value; if (!web3.utils.isAddress(addr)) return showNotification("Invalid Ethereum address.", true); setButtonProcessing('grantRoleBtn', true); try { await contract.methods.grantIssuerRole(addr).send({ from: account }); showNotification("‚úÖ Role Granted!"); } catch (e) { showNotification("‚ùå Error: " + e.message, true); } finally { setButtonProcessing('grantRoleBtn', false); } }
        async function revokeRole() { if (!contract) return; const addr = document.getElementById('issuerAddress').value; if (!web3.utils.isAddress(addr)) return showNotification("Invalid Ethereum address.", true); setButtonProcessing('revokeRoleBtn', true); try { await contract.methods.revokeIssuerRole(addr).send({ from: account }); showNotification("‚úÖ Role Revoked!"); } catch (e) { showNotification("‚ùå Error: " + e.message, true); } finally { setButtonProcessing('revokeRoleBtn', false); } }
        function handleFileUpload(event) { const f = event.target.files[0]; if (!f) return; Papa.parse(f, { header: true, skipEmptyLines: true, complete: function(res) { const req = ['hash', 'recipientName', 'courseTitle', 'grade']; const act = res.meta.fields; if (!req.every(h => act.includes(h))) { showNotification("CSV headers must be: hash, recipientName, courseTitle, grade", true); return; } batchToIssue = [...batchToIssue, ...res.data]; renderBatchTable(); showNotification(`‚úÖ Loaded ${res.data.length} records from CSV.`); }, error: function(err) { showNotification("CSV parsing error: " + err.message, true); } }); event.target.value = ''; }
        function generateQRCode(text) { const c = document.getElementById("qrCanvas"); QRCode.toCanvas(c, text, { width: 180, margin: 2, color: { dark: '#1a0f35', light: '#ffffff' } }, (err) => { if (err) console.error(err); }); }
        function copyLink() { const h = document.getElementById("verifyHashInput").value; if (!h) return showNotification("No hash to copy.", true); const url = `${window.location.origin}${window.location.pathname}?certHash=${h}`; navigator.clipboard.writeText(url); showNotification("üìã Link copied!"); }
        function downloadQR() { const c = document.getElementById("qrCanvas"); const link = document.createElement('a'); link.download = 'certificate-qr.png'; link.href = c.toDataURL('image/png'); link.click(); }
        async function shareQR() { const c = document.getElementById("qrCanvas"); c.toBlob(async (blob) => { const f = new File([blob], 'certificate-qr.png', { type: 'image/png' }); if (navigator.share && navigator.canShare({ files: [f] })) { try { await navigator.share({ files: [f], title: 'Certificate QR', text: 'Scan to verify this certificate' }); } catch (e) { if (e.name !== "AbortError") showNotification("Sharing failed.", true); } } else { showNotification("Web Share not supported on this device.", true); } }, 'image/png'); }
        async function checkForUrlHash() { const p = new URLSearchParams(window.location.search); const ch = p.get('certHash'); if (ch) { showTab('verify'); document.getElementById('verifyHashInput').value = ch; await connectWallet(); if (account) verifyCert(); } }
        function initParticles() { particlesJS("particles-js", {"particles":{"number":{"value":60,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.8,"random":true,"anim":{"enable":true,"speed":1,"opacity_min":0.1,"sync":false}},"size":{"value":3,"random":true,"anim":{"enable":false}},"line_linked":{"enable":true,"distance":150,"color":"#ffffff","opacity":0.2,"width":1},"move":{"enable":true,"speed":3,"direction":"none","random":true,"straight":false,"out_mode":"out","bounce":false}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"},"resize":true},"modes":{"grab":{"distance":140,"line_linked":{"opacity":0.5}},"bubble":{"distance":400,"size":40,"duration":2,"opacity":8,"speed":3},"repulse":{"distance":200,"duration":0.4},"push":{"particles_nb":4},"remove":{"particles_nb":2}}},"retina_detect":true}); }

    </script>
</body>
</html>
