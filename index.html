<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Certificate Registry DApp â€” Pro (On-chain + Bulk)</title>

<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
:root{
Â  --bg-1:#071A2B; --bg-2:#0E2B44;
Â  --card: rgba(255,255,255,0.04);
Â  --muted: rgba(255,255,255,0.78);
Â  --accent-yellow:#ffd24a; --accent-yellow-2:#ffcf3b;
Â  --danger:#ff6b6b; --success:#4ade80;
}
/* --- Light Theme Styles --- */
:root.light {
Â  --bg-1: #f0f4f8; --bg-2: #ffffff;
Â  --card: rgba(0,0,0,0.04);
Â  --muted: #333;
Â  --accent-yellow: #f59e0b; --accent-yellow-2: #d97706;
Â  --danger:#ef4444; --success:#22c55e;
}
.light h1, .light .tab.active, .light strong, .light .btn-yellow, .light #walletStatus { color: #1e293b; }
.light .subtitle, .light label, .light .mini, .light .footer, .light .tab { color: #475569; }
.light input, .light select, .light textarea { background: rgba(0,0,0,0.02); border-color: rgba(0,0,0,0.1); color: #1e293b; }
.light .qr-badge { background: #e2e8f0; }
.light .card { background: linear-gradient(180deg,rgba(255,255,255,0.8), #fff); border-color: rgba(0,0,0,0.08); }
.light .controls .btn, .light .small-btn { background: rgba(0,0,0,0.06); color: #1e293b; }
.light #liveConsole { color: #334155; }
/* --- End of Light Theme styles --- */

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Space Grotesk',system-ui,Segoe UI,Roboto,sans-serif;color:var(--muted);background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
header{padding:18px 14px;text-align:center}
h1{margin:0;color:#fff;font-family:'Fredoka One',cursive;font-size:30px}
.subtitle{color:rgba(255,255,255,0.75);margin-top:6px;font-size:13px}

.top-controls{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px;flex-wrap:wrap}
.btn{border:0;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:700}
.btn-yellow{background:linear-gradient(180deg,var(--accent-yellow),var(--accent-yellow-2));color:#0b2735}
.btn-pill{background:#fff;color:#0b2740;padding:8px 12px;border-radius:20px}
.status{margin-top:8px;color:#ffd;font-weight:600;font-size:13px}

main{max-width:1150px;margin:16px auto;padding:0 12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 18px 40px rgba(0,0,0,0.35)}
.tabs{display:flex;gap:8px;padding:8px;border-radius:12px;margin-bottom:12px}
.tab{flex:1;text-align:center;padding:12px;border-radius:12px;cursor:pointer;background:rgba(255,255,255,0.03);color:#cfe6ff;font-weight:700}
.tab.active{background:rgba(255,255,255,0.06);color:#fff}

.grid{display:grid;grid-template-columns:1fr 420px;gap:14px;align-items:start}
@media (max-width:960px){ .grid{grid-template-columns:1fr} }

.field{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);color:var(--muted);margin-bottom:10px}
label{display:block;font-size:13px;margin-bottom:8px;color:rgba(255,255,255,0.9)}
input[type="text"], input[type="date"], input[type="file"], select, textarea {
Â  width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;
}
textarea{min-height:70px;resize:vertical}

.iframe-preview{width:100%;height:280px;border-radius:8px;border:0;background:#fff;display:none}

.qr-area{display:flex;gap:12px;align-items:center;flex-direction:column}
.qr-badge{padding:12px;background:#0b1b2b;border-radius:12px;border:1px solid rgba(255,255,255,0.035);box-shadow:0 10px 20px rgba(0,0,0,0.45)}
canvas.qr{background:#fff;border-radius:10px;padding:8px;display:block}

.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.controls .btn{font-size:14px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.06);color:#fff}

.issued-list{margin-top:12px;max-height:300px;overflow:auto;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02)}
.issued-item{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);font-size:13px}
.mini{font-size:12px;color:rgba(255,255,255,0.75)}
.small{font-size:12px}
.flex{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}

#reader{width:100%;max-width:420px;margin-top:12px;border-radius:8px;overflow:hidden;background:#07121a}

.footer{margin-top:14px;text-align:center;color:rgba(255,255,255,0.6);font-size:13px}

/* toast */
.toast{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.85);padding:10px 14px;border-radius:10px;color:#fff;display:none;z-index:9999}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,0.04);padding:8px;text-align:left;font-size:13px}
.small-btn{padding:6px 8px;border-radius:8px;border:0;cursor:pointer;background:rgba(255,255,255,0.05);color:#fff}
.file-input{padding:6px 0}
</style>
</head>
<body>
<header>
Â  <h1>Certificate Registry DApp â€” Pro</h1>
Â  <div class="subtitle">Issue â€¢ Verify â€¢ Revoke â€¢ Bulk Issuance â€¢ QR â€¢ Local History</div>

Â  <div class="top-controls">
Â  Â  <button id="connectBtn" class="btn btn-yellow">ğŸ”— Connect Wallet</button>
Â  Â  <button id="themeBtn" class="btn btn-pill">ğŸŒ— Theme</button>
Â  </div>
Â  <div id="walletStatus" class="status">ğŸ§­ Wallet not connected</div>
</header>

<main>
Â  <div class="card">
Â  Â  <div class="tabs" role="tablist">
Â  Â  Â  <div class="tab active" data-tab="issue">Issue</div>
Â  Â  Â  <div class="tab" data-tab="verify">Verify</div>
Â  Â  Â  <div class="tab" data-tab="revoke">Revoke</div>
Â  Â  Â  <div class="tab" data-tab="institution">Institution (Single / CSV)</div>
Â  Â  </div>

Â  Â  <div class="grid">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="panel-issue" class="panel">
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label>Upload Certificate (PDF) â€” Preview & SHA-256 Hash</label>
Â  Â  Â  Â  Â  Â  <input id="fileInput" type="file" accept="application/pdf" class="file-input"/>
Â  Â  Â  Â  Â  _ <iframe id="pdfPreview" class="iframe-preview"></iframe>
Â  Â  Â  Â  Â  Â  <div style="margin-top:10px" class="flex">
Â  Â  Â  Â  Â  Â  Â  <button id="genHashBtn" class="btn">ğŸ“„ Generate Hash</button>
Â  Â  Â  Â  Â  Â  Â  <button id="issueBtn" class="btn" style="background:var(--accent-yellow);color:#072;font-weight:800">âœ… Issue On-Chain</button>
Â  Â  Â  Â  Â  Â  Â  <div class="right mini" id="issueStatus"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="field" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
Â  Â  Â  Â  Â  Â  <div><label>Student Name</label><input id="studentName" type="text" placeholder="e.g., A. Sharma" /></div>
Â  Â  Â  Â  Â  Â  <div><label>Course / Program</label><input id="courseName" type="text" placeholder="e.g., Blockchain Fundamentals" /></div>
Â  Â  Â  Â  Â  Â  <div><label>Institution</label><input id="institutionName" type="text" placeholder="e.g., ABC Institute" /></div>
Â  Â  Â  Â  Â  Â  <div><label>Grade (0-255)</label><input id="grade" type="text" placeholder="e.g., 85" /></div>
Â  Â  Â  Â  Â  Â  <div><label>Issue Date</label><input id="issueDate" type="date" /></div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label>Certificate Hash (0x...)</label>
Â  Â  Â  Â  Â  Â  <input id="hashInput" type="text" placeholder="0x..." />
Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  <button id="copyLinkBtn" class="btn">ğŸ“‹ Copy Verify Link</button>
Â  Â  Â  Â  Â  Â  Â  <button id="downloadQRBtn" class="btn">â¬‡ï¸ Download QR</button>
Â  Â  Â  Â  Â  Â  Â  <button id="shareQRBtn" class="btn">ğŸ“¤ Share QR</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <strong style="color:#fff">ğŸ“ Local History</strong>
Â  Â  Â  Â  Â  Â  <div id="issuedList" class="issued-list mini"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="panel-verify" class="panel" style="display:none">
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label>Enter Certificate Hash</label>
Â  Â  Â  Â  Â  Â  <input id="verifyHash" type="text" placeholder="0x..." />
Â  Â  Â  Â  Â  Â  <div style="margin-top:8px" class="flex">
Â  Â  Â  Â  Â  Â  Â  <button id="verifyBtn" class="btn">ğŸ” Verify On-Chain</button>
Â  Â  Â  Â  Â  Â  Â  <div class="right mini" id="verifyStatus"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <pre id="verifyResult" class="mini" style="white-space:pre-wrap;margin-top:8px"></pre>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="panel-revoke" class="panel" style="display:none">
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label>Certificate Hash to Revoke</label>
Â  Â  Â  Â  Â  Â  <input id="revokeHash" type="text" placeholder="0x..." />
Â  Â  Â  Â  Â  Â  <div style="margin-top:8px" class="flex">
Â  Â  Â  Â  Â  Â  Â  <button id="revokeBtn" class="btn" style="background:var(--danger);color:#fff">âŒ Revoke On-Chain</button>
Â  Â  Â  Â  Â  Â  Â  <div class="right mini" id="revokeStatus"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="panel-institution" class="panel" style="display:none">
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label>Add Single Student (manual)</label>
Â  Â  Â  Â  Â  Â  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
Â  Â  Â  Â  Â  Â  Â  <input id="inst_name" type="text" placeholder="Student name"/>
Â  Â  Â  Â  Â  Â  Â  <input id="inst_course" type="text" placeholder="Course"/>
Â  Â  Â  Â  Â  Â  Â  <input id="inst_institution" type="text" placeholder="Institution"/>
Â  Â  Â  Â  Â  Â  Â  <input id="inst_grade" type="text" placeholder="Grade (0-255)"/>
Â  Â  Â  Â  Â  Â  Â  <input id="inst_date" type="date"/>
Â  Â  Â  Â  Â  Â  Â  <input id="inst_fileInput" type="file" accept="application/pdf" class="file-input" style="grid-column: span 2;"/>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:8px" class="flex">
Â  Â  Â  Â  Â  Â  Â  <button id="inst_generate" class="btn">Generate Random Hash</button>
Â  Â  Â  Â  Â  Â  Â  <button id="inst_issue_single" class="btn" style="background:var(--accent-yellow);color:#072">Issue On-Chain</button>
Â  Â  Â  Â  Â  Â  Â  <div class="right mini" id="instStatus"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label>Bulk CSV Upload (CSV columns: name,course,institution,grade,date)</label>
Â  Â  Â  Â  Â  Â  <input id="csvInput" type="file" accept=".csv" class="file-input"/>
Â  Â  Â  Â  Â  Â  <div style="margin-top:8px" class="flex">
Â  Â  Â  Â  Â  Â  Â  <button id="csvGenerateHashesBtn" class="btn">ğŸ“„ Generate Hashes from CSV</button>
Â  Â  Â  Â  Â  Â  Â  <button id="csvIssueAllBtn" class="btn" style="background:var(--accent-yellow);color:#072">âœ… Issue All On-Chain</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="csvPreview" style="margin-top:10px; max-height: 150px; overflow-y: auto;" class="mini"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  <div class="qr-area">
Â  Â  Â  Â  Â  <div class="qr-badge">
Â  Â  Â  Â  Â  Â  <canvas id="qrCanvas" class="qr" width="220" height="220"></canvas>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="width:100%" class="mini">
Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  Â  Â  Â  Â  <div style="flex:1"><strong style="color:#fff">Quick Actions</strong></div>
Â  Â  Â  Â  Â  Â  Â  <div style="flex:1;text-align:right" id="networkLabel" class="mini"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="margin-top:10px" class="mini">
Â  Â  Â  Â  Â  Â  Â  Generate a certificate hash, then Issue on-chain (writes hash & metadata). Use Institution tab for CSV/batch issuance.
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="field" style="margin-top:12px">
Â  Â  Â  Â  Â  <strong style="color:#fff">Live Console</strong>
Â  Â  Â  Â  Â  <div id="liveConsole" class="mini" style="margin-top:8px;max-height:200px;overflow:auto"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div> Â  </div> Â  <div class="card" style="margin-top:14px">
Â  Â  <strong>All Issued Certificates (local)</strong>
Â  Â  <div id="historyTable" style="margin-top:8px" class="mini"></div>
Â  </div>

Â  <div class="footer">Tip: Save as <code>index.html</code>, open in Chrome, allow wallet permissions.</div>
</main>

<div id="toast" class="toast"></div>

<script>
/* =========================
Â  Â Contract address + ABI
Â  Â ========================= */
const contractAddress = "0x17f405356cc1101E1e04f31901d4eAcaaBb7A0C4";
const contractABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			}
		],
		"name": "addIssuer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721IncorrectOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721InsufficientApproval",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "approver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidApprover",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOperator",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidReceiver",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "ERC721InvalidSender",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721NonexistentToken",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "student",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "tokenURI",
				"type": "string"
			}
		],
		"name": "issueCredential",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "approved",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "ApprovalForAll",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_fromTokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_toTokenId",
				"type": "uint256"
			}
		],
		"name": "BatchMetadataUpdate",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_tokenId",
				"type": "uint256"
			}
		],
		"name": "MetadataUpdate",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			}
		],
		"name": "removeIssuer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "revokeCredential",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "setApprovalForAll",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "authorizedIssuers",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getApproved",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "isApprovedForAll",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "nextTokenId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ownerOf",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "revoked",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes4",
				"name": "interfaceId",
				"type": "bytes4"
			}
		],
		"name": "supportsInterface",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "tokenURI",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "verifyCredential",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];


/* =========================
Â  Â App State
Â  Â ========================= */
let web3, contract, account;
const LS_KEY = 'certs_v3_local';
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* =========================
Â  Â Utils: Toast + console
Â  Â ========================= */
function showToast(msg, timeout=3500){
Â  const t = $('#toast');
Â  t.textContent = msg; t.style.display = 'block';
Â  setTimeout(()=> t.style.display='none', timeout);
}
function logLive(msg){
Â  const el = $('#liveConsole');
Â  const time = new Date().toLocaleTimeString();
Â  el.innerText = `[${time}] ${msg}\n` + el.innerText;
}

/* =========================
Â  Â Theme
Â  Â ========================= */
$('#themeBtn').addEventListener('click', ()=>{
Â  document.documentElement.classList.toggle('light');
Â  const val = document.documentElement.classList.contains('light') ? 'light' : 'dark';
Â  localStorage.setItem('dapp_theme', val);
});
(function initTheme(){ const v = localStorage.getItem('dapp_theme') || 'light'; if(v==='light') document.documentElement.classList.add('light'); })();

/* =========================
Â  Â Tabs
Â  Â ========================= */
$$('.tab').forEach(t=> t.addEventListener('click', () => {
Â  $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
Â  $$('.panel').forEach(p=>p.style.display='none');
Â  document.getElementById('panel-' + t.dataset.tab).style.display = 'block';
}));

document.querySelectorAll('.tab').forEach(t => t.classList.contains('active') ? null : null);
document.getElementById('panel-issue').style.display = 'block';

/* =========================
Â  Â Wallet connect
Â  Â ========================= */
$('#connectBtn').addEventListener('click', async ()=>{
Â  if(!window.ethereum){ alert('Please install MetaMask'); return; }
Â  try {
Â  Â  web3 = new Web3(window.ethereum);
Â  Â  const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
Â  Â  account = accs[0];
Â  Â  contract = new web3.eth.Contract(contractABI, contractAddress);
Â  Â  $('#connectBtn').innerText = 'âœ… Connected';
Â  Â  $('#walletStatus').innerText = 'ğŸŸ¢ Connected: ' + account;
Â  Â  const netId = await web3.eth.net.getId();
Â  Â  $('#networkLabel').innerText = 'Network: ' + netId;
Â  Â  logLive('Wallet connected: ' + account);
Â  Â  window.ethereum.on('accountsChanged', (accs)=> { account = accs[0]; $('#walletStatus').innerText = 'ğŸŸ¢ Connected: ' + account; });
Â  Â  window.ethereum.on('chainChanged', ()=> location.reload());
Â  Â  renderIssued();
Â  } catch(e){
Â  Â  console.error(e); showToast('Wallet connection failed: ' + (e.message||e)); logLive('Connect failed: ' + (e.message||e));
Â  }
});

/* =========================
Â  Â SHA256 Hash generation (PDF)
Â  Â ========================= */
$('#genHashBtn').addEventListener('click', async ()=>{
Â  const file = $('#fileInput').files[0];
Â  if(!file) return alert('Please select a PDF first.');
Â  try {
Â  Â  $('#pdfPreview').src = URL.createObjectURL(file);
Â  Â  $('#pdfPreview').style.display = 'block';
Â  Â  const ab = await file.arrayBuffer();
Â  Â  const digest = await crypto.subtle.digest('SHA-256', ab);
Â  Â  const arr = Array.from(new Uint8Array(digest));
Â  Â  const hex = '0x' + arr.map(b=>b.toString(16).padStart(2,'0')).join('');
Â  Â  $('#hashInput').value = hex;
Â  Â  drawQRCode(hex);
Â  Â  setMini('issueStatus','Hash generated');
Â  Â  logLive('Hash generated: ' + hex);
Â  } catch(e){ console.error(e); showToast('Hash error'); }
});

function setMini(id, txt){ const el=document.getElementById(id); if(el) el.innerText = txt; }

/* =========================
Â  Â Draw QR
Â  Â ========================= */
function drawQRCode(text){
Â  if(!text) return;
Â  try { QRCode.toCanvas($('#qrCanvas'), text, { width:220, margin:1 }, err => { if(err) console.error(err); }); } catch(e){ console.error(e); }
}

$('#hashInput').addEventListener('input', (e)=> {
Â  const v=e.target.value.trim();
Â  if(/^0x[0-9a-fA-F]{64}$/.test(v)){ $('#verifyHash').value=v; $('#revokeHash').value=v; drawQRCode(v); }
});

/* =========================
Â  Â Local Storage helpers
Â  Â ========================= */
function getLocal(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{return []} }
function saveLocal(entry){ const arr=getLocal(); arr.unshift(entry); localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0,1000))); }
function renderIssued(){
Â  const items = getLocal();
Â  const container = $('#issuedList');
Â  container.innerHTML = '';
Â  if(!items.length){ container.innerHTML = '<div class="mini">No local records yet</div>'; renderHistoryTable(); return; }
Â  items.forEach(it=>{
Â  Â  const div = document.createElement('div'); div.className='issued-item';
Â  Â  div.innerHTML = `
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  <div><strong style="color:#fff">${it.name||'â€”'}</strong><div class="mini">${it.course||'â€”'} â€¢ ${it.institution||'â€”'}</div></div>
Â  Â  Â  Â  <div class="mini">${new Date(it.ts||Date.now()).toLocaleString()}</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="mini" style="margin-top:8px;word-break:break-all">${it.hash}</div>
Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  <button class="small-btn" data-act="copy" data-h="${it.hash}">Copy Link</button>
Â  Â  Â  Â  <button class="small-btn" data-act="qr" data-h="${it.hash}">Show QR</button>
Â  Â  Â  Â  <button class="small-btn" data-act="verify" data-h="${it.hash}">Verify</button>
Â  Â  Â  Â  <button class="small-btn" data-act="revoke" data-h="${it.hash}">Revoke</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="mini" style="margin-top:6px">${it.txHash?('tx:'+it.txHash):''}${it.revoked?(' â€¢ REVOKED'):''}</div>
Â  Â  `;
Â  Â  container.appendChild(div);
Â  });

Â  container.querySelectorAll('button').forEach(b=>{
Â  Â  b.onclick = async (ev) => {
Â  Â  Â  const act = ev.currentTarget.dataset.act;
Â  Â  Â  const h = ev.currentTarget.dataset.h;
Â  Â  Â  if(act==='copy'){ navigator.clipboard.writeText(buildVerifyURL(h)); showToast('Link copied'); }
Â  Â  Â  else if(act==='qr'){ $('#hashInput').value=h; drawQRCode(h); }
Â  Â  Â  else if(act==='verify'){ $('#verifyHash').value=h; $$('.tab').forEach(t=>t.classList.remove('active')); document.querySelector('.tab[data-tab=\"verify\"]').classList.add('active'); $$('.panel').forEach(p=>p.style.display='none'); document.getElementById('panel-verify').style.display='block'; $('#verifyBtn').click(); }
Â  Â  Â  else if(act==='revoke'){ $('#revokeHash').value=h; $$('.tab').forEach(t=>t.classList.remove('active')); document.querySelector('.tab[data-tab=\"revoke\"]').classList.add('active'); $$('.panel').forEach(p=>p.style.display='none'); document.getElementById('panel-revoke').style.display='block'; $('#revokeBtn').click(); }
Â  Â  };
Â  });

Â  renderHistoryTable();
}

function renderHistoryTable(){
Â  const items=getLocal();
Â  const container = $('#historyTable'); if(!items.length){ container.innerHTML='<div class="mini">No history</div>'; return; }
Â  let html = '<table class="table"><thead><tr><th>When</th><th>Recipient</th><th>Course</th><th>Hash</th><th>Actions</th></tr></thead><tbody>';
Â  items.forEach(it=>{
Â  Â  html += `<tr><td>${new Date(it.ts||Date.now()).toLocaleString()}</td><td>${it.name||'â€”'}</td><td>${it.course||'â€”'}</td><td style="word-break:break-all">${it.hash}</td>
Â  Â  Â  <td><button class="small-btn" onclick="navigator.clipboard.writeText('${buildVerifyURL(it.hash)}')">Copy</button>
Â  Â  Â  Â  Â  <button class="small-btn" onclick="document.getElementById('hashInput').value='${it.hash}'; drawQRCode('${it.hash}')">QR</button>
Â  Â  Â  Â  Â  <button class="small-btn" onclick="document.getElementById('verifyHash').value='${it.hash}'; document.querySelector('.tab[data-tab=verify]').click(); setTimeout(()=>document.getElementById('verifyBtn').click(),400)">Verify</button></td></tr>`;
Â  });
Â  html += '</tbody></table>';
Â  container.innerHTML = html;
}

/* =========================
Â  Â Build verify link
Â  Â ========================= */
function buildVerifyURL(hash){ return location.origin + location.pathname + '?certHash=' + encodeURIComponent(hash); }

/* =========================
Â  Â Issue On-chain (single)
Â  Â ========================= */
$('#issueBtn').addEventListener('click', async ()=>{
Â  if(!contract || !account){ showToast('Connect wallet first'); return; }
Â  const hash = $('#hashInput').value.trim();
Â  if(!/^0x[0-9a-fA-F]{64}$/.test(hash)){ alert('Hash must be 0x + 64 hex chars. Generate from PDF.'); return; }
Â  const recipient = $('#studentName').value.trim() || 'â€”';
Â  const course = $('#courseName').value.trim() || 'â€”';
Â  const institution = $('#institutionName').value.trim() || 'â€”';
Â  let grade = parseInt($('#grade').value,10); if(Number.isNaN(grade)) grade = 0; if(grade < 0) grade = 0; if(grade > 255) grade = 255;
Â  const ipfsCid = ""; 
Â  try {
Â  Â  setMini('issueStatus','Sending tx...');
Â  Â  logLive('Issuing certificate: ' + hash);
Â  Â  const gas = await contract.methods.issueCertificate(hash, recipient, course, grade, ipfsCid).estimateGas({ from: account });
Â  Â  const tx = await contract.methods.issueCertificate(hash, recipient, course, grade, ipfsCid).send({ from: account, gas: Math.floor(gas * 1.2) });
Â  Â  showToast('Issued on-chain: ' + tx.transactionHash, 5000);
Â  Â  setMini('issueStatus','Issued: ' + tx.transactionHash);
Â  Â  const meta = { hash, name: recipient, course, institution, grade, ts: Date.now(), txHash: tx.transactionHash };
Â  Â  saveLocal(meta); renderIssued();
Â  Â  logLive('Issue tx: ' + tx.transactionHash);
Â  } catch(e){ console.error(e); showToast('Issue failed: ' + (e.message||e)); setMini('issueStatus','Error'); logLive('Issue failed: ' + (e.message||e)); }
});

/* =========================
Â  Â Verify (getCertificateDetails)
Â  Â ========================= */
$('#verifyBtn').addEventListener('click', async ()=>{
Â  if(!contract){ showToast('Connect wallet to verify (calls node)'); return; }
Â  const hash = $('#verifyHash').value.trim();
Â  if(!/^0x[0-9a-fA-F]{64}$/.test(hash)){ alert('Enter 0x + 64 hex chars'); return; }
Â  try {
Â  Â  setMini('verifyStatus','Checking...');
Â  Â  logLive('Verifying: ' + hash);
Â  Â  const details = await contract.methods.getCertificateDetails(hash).call();
Â  Â  const issuer = details.issuer || details[0];
Â  Â  const issueDate = Number(details.issueDate || details[1] || 0);
Â  Â  const isValid = (details.isValid !== undefined) ? details.isValid : details[2];
Â  Â  const recipientName = details.recipientName || details[3] || '';
Â  Â  const courseTitle = details.courseTitle || details[4] || '';
Â  Â  const grade = (details.grade !== undefined) ? details.grade : details[5];
Â  Â  const ipfsCid = details.ipfsCid || details[6] || '';
Â  Â  const validText = isValid ? 'âœ… VALID (on-chain)' : 'âŒ NOT VALID';
Â  Â  const issueWhen = issueDate ? new Date(issueDate * 1000).toLocaleString() : 'â€”';
Â  Â  const out = `${validText}\nIssuer: ${issuer}\nIssued: ${issueWhen}\nRecipient: ${recipientName}\nCourse: ${courseTitle}\nGrade: ${grade}\nIPFS CID: ${ipfsCid}`;
Â  Â  $('#verifyResult').innerText = out;
Â  Â  setMini('verifyStatus','Done');
Â  Â  logLive('Verify result shown');
Â  } catch(e){ console.error(e); showToast('Verify failed: ' + (e.message||e)); setMini('verifyStatus','Error'); logLive('Verify failed: ' + (e.message||e)); }
});

/* =========================
Â  Â Revoke
Â  Â ========================= */
$('#revokeBtn').addEventListener('click', async ()=>{
Â  if(!contract || !account){ showToast('Connect wallet'); return; }
Â  const hash = $('#revokeHash').value.trim();
Â  if(!/^0x[0-9a-fA-F]{64}$/.test(hash)){ alert('Enter 0x + 64 hex chars'); return; }
Â  try {
Â  Â  setMini('revokeStatus','Sending revoke tx...');
Â  Â  logLive('Revoking: ' + hash);
Â  Â  const gas = await contract.methods.revokeCertificate(hash).estimateGas({ from: account });
Â  Â  const tx = await contract.methods.revokeCertificate(hash).send({ from: account, gas: Math.floor(gas * 1.2) });
Â  Â  showToast('Revoked: ' + tx.transactionHash);
Â  Â  const list = getLocal(); const idx = list.findIndex(i=>i.hash===hash);
Â  Â  if(idx>-1){ list[idx].revoked = true; list[idx].revokeTx = tx.transactionHash; localStorage.setItem(LS_KEY, JSON.stringify(list)); renderIssued(); }
Â  Â  setMini('revokeStatus','Revoked: ' + tx.transactionHash);
Â  Â  logLive('Revoke tx: ' + tx.transactionHash);
Â  } catch(e){ console.error(e); showToast('Revoke failed: ' + (e.message||e)); setMini('revokeStatus','Error'); logLive('Revoke failed: ' + (e.message||e)); }
});

/* =========================
Â  Â QR copy / download / share
Â  Â ========================= */
$('#copyLinkBtn').addEventListener('click', ()=>{ const h=$('#hashInput').value.trim(); if(!h){showToast('No hash');return;} navigator.clipboard.writeText(buildVerifyURL(h)); showToast('Link copied'); });
$('#downloadQRBtn').addEventListener('click', ()=>{ const c = $('#qrCanvas'); const a=document.createElement('a'); a.download='certificate_qr.png'; a.href=c.toDataURL('image/png'); a.click(); });
$('#shareQRBtn').addEventListener('click', ()=>{ const c = $('#qrCanvas'); c.toBlob(async blob => { const file = new File([blob],'certificate_qr.png',{type:'image/png'}); if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file], title:'Certificate QR'}); } else showToast('Sharing not supported'); }); });

/* =========================
Â  Â Institution Single generate / issue
Â  Â ========================= */
$('#inst_generate').addEventListener('click', ()=>{
Â  const name = $('#inst_name').value.trim();
Â  const rand = crypto.getRandomValues(new Uint8Array(32));
Â  const hash = '0x' + Array.from(rand).map(b=>b.toString(16).padStart(2,'0')).join('');
Â  $('#hashInput').value = hash; drawQRCode(hash);
Â  setMini('instStatus','Random hash generated');
Â  showToast('Random hash generated for ' + (name||'student'));
});

$('#inst_issue_single').addEventListener('click', async ()=>{
Â  $('#studentName').value = $('#inst_name').value;
Â  $('#courseName').value = $('#inst_course').value;
Â  $('#institutionName').value = $('#inst_institution').value;
Â  $('#grade').value = $('#inst_grade').value;
Â  $('#issueDate').value = $('#inst_date').value;
Â  if(!$('#hashInput').value) { showToast('Generate a hash first (randomly or from file)'); return; }
Â  $('#issueBtn').click();
});

$('#inst_fileInput').addEventListener('change', async (event)=>{
Â  Â  const file = event.target.files[0];
Â  Â  if(!file) return;
Â  Â  try {
Â  Â  Â  Â  const ab = await file.arrayBuffer();
Â  Â  Â  Â  const digest = await crypto.subtle.digest('SHA-256', ab);
Â  Â  Â  Â  const arr = Array.from(new Uint8Array(digest));
Â  Â  Â  Â  const hex = '0x' + arr.map(b=>b.toString(16).padStart(2,'0')).join('');
Â  Â  Â  Â  $('#hashInput').value = hex;
Â  Â  Â  Â  drawQRCode(hex);
Â  Â  Â  Â  setMini('instStatus','Hash generated from file.');
Â  Â  Â  Â  logLive('Hash generated from institution file: ' + hex);
Â  Â  } catch(e){
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  showToast('Hash generation error: ' + (e.message || e));
Â  Â  Â  Â  setMini('instStatus','File hash error.');
Â  Â  }
});


/* =========================
Â  Â CSV parse & bulk actions
Â  Â ========================= */
let csvRows = [];
$('#csvGenerateHashesBtn').addEventListener('click', async ()=>{
Â  Â  const file = $('#csvInput').files[0];
Â  Â  if(!file) return alert('Choose CSV file');
Â  Â  const text = await file.text();
Â  Â  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length);
Â  Â  let start = 0; const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
Â  Â  const hasHeader = headers.some(h=>['name','course','institution','grade','date'].includes(h));
Â  Â  if(hasHeader){ start = 1; }
Â  Â  
Â  Â  csvRows = []; // Reset
Â  Â  for(let i=start;i<lines.length;i++){
Â  Â  Â  Â  const cols = lines[i].split(',').map(c=>c.trim());
Â  Â  Â  Â  let rowData = {};
Â  Â  Â  Â  if(hasHeader){
Â  Â  Â  Â  Â  Â  const obj = {};
Â  Â  Â  Â  Â  Â  headers.forEach((h, idx)=> obj[h]=cols[idx]||'');
Â  Â  Â  Â  Â  Â  rowData = {
Â  Â  Â  Â  Â  Â  Â  Â  name: obj.name || obj.recipient || 'â€”',
Â  Â  Â  Â  Â  Â  Â  Â  course: obj.course || obj.coursetitle || 'â€”',
Â  Â  Â  Â  Â  Â  Â  Â  institution: obj.institution || 'â€”',
Â  Â  Â  Â  Â  Â  Â  Â  grade: parseInt(obj.grade,10) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  date: obj.date || new Date().toISOString().split('T')[0]
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  rowData = {
Â  Â  Â  Â  Â  Â  Â  Â  name: cols[0]||'â€”',
Â  Â  Â  Â  Â  Â  Â  Â  course: cols[1]||'â€”',
Â  Â  Â  Â  Â  Â  Â  Â  institution: cols[2]||'â€”',
Â  Â  Â  Â  Â  Â  Â  Â  grade: parseInt(cols[3],10) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  date: cols[4] || new Date().toISOString().split('T')[0]
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â  const rand = crypto.getRandomValues(new Uint8Array(32));
Â  Â  Â  Â  const hash = '0x' + Array.from(rand).map(b=>b.toString(16).padStart(2,'0')).join('');
Â  Â  Â  Â  rowData.hash = hash;
Â  Â  Â  Â  csvRows.push(rowData);
Â  Â  }

Â  Â  let previewHtml = 'Generated Hashes for ' + csvRows.length + ' rows:<br>';
Â  Â  previewHtml += csvRows.slice(0, 5).map(r => `<strong>${r.name}</strong>: <span style="font-family:monospace; font-size:11px;">${r.hash.substring(0,22)}...</span>`).join('<br>');
Â  Â  if(csvRows.length > 5) previewHtml += '<br>...and more.';
Â  Â  $('#csvPreview').innerHTML = previewHtml;

Â  Â  showToast('Generated hashes for ' + csvRows.length + ' rows');
Â  Â  logLive('Generated hashes from CSV for ' + csvRows.length + ' rows.');
});

$('#csvIssueAllBtn').addEventListener('click', async ()=>{
Â  Â  if(!csvRows.length || !csvRows[0].hash) return alert('Please generate hashes from a CSV file first.');
Â  Â  if(!contract || !account) { showToast('Connect wallet first'); return; }
Â  Â  
Â  Â  try {
Â  Â  Â  Â  const hashes = csvRows.map(r => r.hash);
Â  Â  Â  Â  const names = csvRows.map(r => r.name || 'â€”');
Â  Â  Â  Â  const courses = csvRows.map(r => r.course || 'â€”');
Â  Â  Â  Â  const grades = csvRows.map(r => {
Â  Â  Â  Â  Â  Â  let g = parseInt(r.grade,10); if(Number.isNaN(g)) g = 0; if(g<0) g=0; if(g>255) g=255; return Number(g);
Â  Â  Â  Â  });
Â  Â  Â  Â  const ipfs = csvRows.map(() => '');

Â  Â  Â  Â  setMini('instStatus','Sending batch tx...');
Â  Â  Â  Â  logLive('Sending batchIssueCertificates for ' + hashes.length + ' certs');
Â  Â  Â  Â  const gas = await contract.methods.batchIssueCertificates(hashes, names, courses, grades, ipfs).estimateGas({ from: account });
Â  Â  Â  Â  const tx = await contract.methods.batchIssueCertificates(hashes, names, courses, grades, ipfs).send({ from: account, gas: Math.floor(gas * 1.3) });
Â  Â  Â  Â  showToast('Batch issued: ' + tx.transactionHash, 6000);
Â  Â  Â  Â  
Â  Â  Â  Â  for(let i=0;i<hashes.length;i++){
Â  Â  Â  Â  Â  Â  saveLocal({ hash: hashes[i], name: names[i], course: courses[i], institution: csvRows[i].institution, grade: grades[i], ts: Date.now(), txHash: tx.transactionHash });
Â  Â  Â  Â  }
Â  Â  Â  Â  renderIssued();
Â  Â  Â  Â  setMini('instStatus','Batch tx: ' + tx.transactionHash);
Â  Â  Â  Â  logLive('Batch tx: ' + tx.transactionHash);
Â  Â  } catch(e){
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  showToast('Batch issue failed: ' + (e.message||e));
Â  Â  Â  Â  setMini('instStatus','Error');
Â  Â  Â  Â  logLive('Batch issue failed: ' + (e.message||e));
Â  Â  }
});

/* =========================
Â  Â Deep-link auto verify
Â  Â ========================= */
(function autoVerifyFromURL(){
Â  const p = new URLSearchParams(location.search);
Â  const h = p.get('certHash');
Â  if(h){
Â  Â  $$('.tab').forEach(t=>t.classList.remove('active'));
Â  Â  document.querySelector('.tab[data-tab="verify"]').classList.add('active');
Â  Â  $$('.panel').forEach(p=>p.style.display='none');
Â  Â  document.getElementById('panel-verify').style.display='block';
Â  Â  $('#verifyHash').value = h;
Â  Â  drawQRCode(h);
Â  Â  setTimeout(()=> $('#verifyBtn').click(), 700);
Â  }
})();

/* =========================
Â  Â Init
Â  Â ========================= */
renderIssued();
drawQRCode('Certificate Registry DApp');
logLive('App initialized');

</script>
</body>
</html>
