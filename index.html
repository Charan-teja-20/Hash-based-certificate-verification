<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Certificate Registry DApp</title>
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<style>
  body {
    background: linear-gradient(135deg, #00c6ff, #0072ff);
    font-family: 'Segoe UI', sans-serif;
    margin: 0; padding: 0;
    text-align: center;
    color: white;
  }
  h1 { margin-top: 20px; font-size: 36px; }
  #connectButton {
    background: #ffdf45; color: black; font-weight: bold;
    padding: 12px 20px; border: none; border-radius: 12px;
    cursor: pointer; transition: background 0.3s;
  }
  #connectButton:hover { background: #ffe769; }
  #status { margin: 10px 0 20px; font-weight: bold; }
  .container {
    background: rgba(255,255,255,0.1);
    padding: 20px; border-radius: 16px; width: 80%; max-width: 900px;
    margin: auto; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }
  input, button {
    margin: 10px 0; padding: 10px; font-size: 16px; border-radius: 8px;
    border: none;
  }
  button.action {
    width: 32%; background: #ffdf45; font-weight: bold;
    cursor: pointer; transition: background 0.3s;
  }
  button.action:hover { background: #ffe769; }
  .card-container {
    display: flex; flex-wrap: wrap; justify-content: center;
    gap: 20px; margin-top: 20px;
  }
  .card {
    background: transparent; width: 250px; height: 300px; perspective: 1000px;
  }
  .card-inner {
    position: relative; width: 100%; height: 100%;
    transition: transform 0.8s; transform-style: preserve-3d;
  }
  .card.flipped .card-inner { transform: rotateY(180deg); }
  .card-front, .card-back {
    position: absolute; width: 100%; height: 100%; border-radius: 12px;
    backface-visibility: hidden; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    padding: 15px; background: rgba(255,255,255,0.15);
  }
  .card-front {
    display: flex; flex-direction: column; justify-content: center;
    color: white;
  }
  .card-back {
    transform: rotateY(180deg); display: flex; flex-direction: column;
    align-items: center; justify-content: center;
  }
  .status-valid { color: #0f0; font-weight: bold; }
  .status-revoked { color: #f33; font-weight: bold; }
  #eventFeed {
    background: rgba(255,255,255,0.1); margin-top: 20px;
    padding: 10px; border-radius: 12px; max-height: 150px; overflow-y: auto;
    text-align: left;
  }
  #qrModal {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center;
  }
  #qrModalContent {
    background:white; padding:20px; border-radius:12px;
    color:black;
  }
</style>
</head>
<body>

<h1>Certificate Registry DApp</h1>
<button id="connectButton">üîó Connect Wallet</button>
<div id="status">üîå Wallet not connected</div>

<div class="container">
  <input type="file" id="fileInput" accept=".pdf" />
  <input type="text" id="hashInput" placeholder="Certificate Hash" style="width:90%" />
  <div>
    <button class="action" onclick="issueCert()">‚úÖ Issue</button>
    <button class="action" onclick="verifyCert()">üîç Verify</button>
    <button class="action" onclick="revokeCert()">‚ùå Revoke</button>
  </div>
  <button onclick="openQRScanner()">üì∑ Scan QR to Verify</button>
</div>

<h2>üìú Certificates</h2>
<div class="card-container" id="certContainer"></div>

<h2>üì¢ Event Feed</h2>
<div id="eventFeed"></div>

<!-- QR Scanner Modal -->
<div id="qrModal">
  <div id="qrModalContent">
    <div id="reader" style="width:300px;"></div>
    <button onclick="closeQRScanner()">Close</button>
  </div>
</div>

<script>
let web3, account, contract;
const contractAddress = "0x8df5b74f5aA6DF84870e9A29ED0569008A6a3733";
const abi = [
 { "inputs": [{ "internalType": "bytes32", "name": "certHash", "type": "bytes32" }], "name": "issueCertificate", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
 { "inputs": [{ "internalType": "bytes32", "name": "certHash", "type": "bytes32" }], "name": "revokeCertificate", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
 { "inputs": [{ "internalType": "bytes32", "name": "certHash", "type": "bytes32" }], "name": "verifyCertificate", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }
];

document.getElementById("connectButton").onclick = connectWallet;
document.getElementById("fileInput").addEventListener("change", autoHash);

async function connectWallet() {
  if (window.ethereum) {
    try {
      web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const accounts = await web3.eth.getAccounts();
      account = accounts[0];
      contract = new web3.eth.Contract(abi, contractAddress);
      document.getElementById("connectButton").innerText = "‚úÖ Wallet Connected";
      document.getElementById("status").innerText = `üü¢ Connected: ${account}`;
    } catch (e) {
      alert("Connection failed: " + e.message);
    }
  } else {
    alert("Please install MetaMask");
  }
}

async function autoHash() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return;
  const arrayBuffer = await file.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest("SHA-256", arrayBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = "0x" + hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  document.getElementById("hashInput").value = hashHex;
}

function addCertCard(cert) {
  const container = document.getElementById("certContainer");
  const card = document.createElement("div");
  card.className = "card";
  card.onclick = () => card.classList.toggle("flipped");

  const inner = document.createElement("div");
  inner.className = "card-inner";

  const front = document.createElement("div");
  front.className = "card-front";
  front.innerHTML = `
    <h3>üìÑ ${cert.name || 'Certificate'}</h3>
    <p>Issuer: ${cert.issuer.slice(0,6)}...${cert.issuer.slice(-4)}</p>
    <p>Date: ${new Date(cert.date).toLocaleString()}</p>
    <p class="${cert.status==='valid'?'status-valid':'status-revoked'}">${cert.status==='valid'?'‚úÖ Valid':'‚ùå Revoked'}</p>
  `;

  const back = document.createElement("div");
  back.className = "card-back";
  const canvas = document.createElement("canvas");
  QRCode.toCanvas(canvas, cert.hash);
  back.appendChild(canvas);

  inner.appendChild(front);
  inner.appendChild(back);
  card.appendChild(inner);
  container.prepend(card);
}

async function issueCert() {
  const hash = document.getElementById("hashInput").value;
  if (!hash) return alert("Please provide a hash");
  try {
    await contract.methods.issueCertificate(hash).send({ from: account });
    const block = await web3.eth.getBlock("latest");
    const cert = { hash, name: document.getElementById("fileInput").files[0]?.name, issuer: account, date: block.timestamp*1000, status: 'valid' };
    saveCert(cert);
    addCertCard(cert);
    addEventFeed(`‚úÖ Issued: ${hash}`);
    launchConfetti();
  } catch (e) {
    alert("Error issuing: " + e.message);
  }
}

async function verifyCert() {
  const hash = document.getElementById("hashInput").value;
  if (!hash) return alert("Enter hash");
  try {
    const isValid = await contract.methods.verifyCertificate(hash).call();
    alert(isValid ? "‚úÖ Valid" : "‚ùå Not valid");
  } catch (e) {
    alert("Error verifying: " + e.message);
  }
}

async function revokeCert() {
  const hash = document.getElementById("hashInput").value;
  if (!hash) return alert("Enter hash");
  try {
    await contract.methods.revokeCertificate(hash).send({ from: account });
    updateCertStatus(hash, 'revoked');
    addEventFeed(`‚ùå Revoked: ${hash}`);
  } catch (e) {
    alert("Error revoking: " + e.message);
  }
}

function saveCert(cert) {
  let certs = JSON.parse(localStorage.getItem("certificates") || "[]");
  certs.unshift(cert);
  localStorage.setItem("certificates", JSON.stringify(certs));
}

function loadCerts() {
  const certs = JSON.parse(localStorage.getItem("certificates") || "[]");
  certs.forEach(addCertCard);
}

function updateCertStatus(hash, status) {
  let certs = JSON.parse(localStorage.getItem("certificates") || "[]");
  certs = certs.map(c => c.hash === hash ? {...c, status} : c);
  localStorage.setItem("certificates", JSON.stringify(certs));
  document.getElementById("certContainer").innerHTML = "";
  certs.forEach(addCertCard);
}

function addEventFeed(text) {
  const feed = document.getElementById("eventFeed");
  const div = document.createElement("div");
  div.textContent = `${new Date().toLocaleTimeString()} - ${text}`;
  feed.prepend(div);
}

function openQRScanner() {
  document.getElementById("qrModal").style.display = "flex";
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      document.getElementById("hashInput").value = qrCodeMessage;
      verifyCert();
      html5QrCode.stop();
      closeQRScanner();
    });
}

function closeQRScanner() {
  document.getElementById("qrModal").style.display = "none";
}

function launchConfetti() {
  // quick confetti effect
  for (let i=0;i<50;i++){
    const conf = document.createElement("div");
    conf.style.position="fixed";conf.style.left=Math.random()*100+"%";conf.style.top="-10px";
    conf.style.width="8px";conf.style.height="8px";conf.style.background=["#ff0","#0f0","#0ff","#f0f","#f00"][Math.floor(Math.random()*5)];
    conf.style.opacity="0.8";conf.style.borderRadius="50%";
    document.body.appendChild(conf);
    let fall=setInterval(()=>{
      conf.style.top=(parseFloat(conf.style.top)+3)+"px";
      if(parseFloat(conf.style.top)>window.innerHeight) {clearInterval(fall);conf.remove();}
    },20);
  }
}

window.onload = loadCerts;
</script>
</body>
</html>
