<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Certificate Registry DApp ‚Äî Pro (On-chain + Bulk)</title>

<!-- Fonts & libs -->
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
:root{
  --bg-1:#071A2B; --bg-2:#0E2B44;
  --card: rgba(255,255,255,0.04);
  --muted: rgba(255,255,255,0.78);
  --accent-yellow:#ffd24a; --accent-yellow-2:#ffcf3b;
  --danger:#ff6b6b; --success:#4ade80;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Space Grotesk',system-ui,Segoe UI,Roboto,sans-serif;color:var(--muted);background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
header{padding:18px 14px;text-align:center}
h1{margin:0;color:#fff;font-family:'Fredoka One',cursive;font-size:30px}
.subtitle{color:rgba(255,255,255,0.75);margin-top:6px;font-size:13px}

.top-controls{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px;flex-wrap:wrap}
.btn{border:0;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:700}
.btn-yellow{background:linear-gradient(180deg,var(--accent-yellow),var(--accent-yellow-2));color:#0b2735}
.btn-pill{background:#fff;color:#0b2740;padding:8px 12px;border-radius:20px}
.status{margin-top:8px;color:#ffd;font-weight:600;font-size:13px}

main{max-width:1150px;margin:16px auto;padding:0 12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 18px 40px rgba(0,0,0,0.35)}
.tabs{display:flex;gap:8px;padding:8px;border-radius:12px;margin-bottom:12px}
.tab{flex:1;text-align:center;padding:12px;border-radius:12px;cursor:pointer;background:rgba(255,255,255,0.03);color:#cfe6ff;font-weight:700}
.tab.active{background:rgba(255,255,255,0.06);color:#fff}

.grid{display:grid;grid-template-columns:1fr 420px;gap:14px;align-items:start}
@media (max-width:960px){ .grid{grid-template-columns:1fr} }

.field{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);color:var(--muted);margin-bottom:10px}
label{display:block;font-size:13px;margin-bottom:8px;color:rgba(255,255,255,0.9)}
input[type="text"], input[type="date"], input[type="file"], select, textarea {
  width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;
}
textarea{min-height:70px;resize:vertical}

.iframe-preview{width:100%;height:280px;border-radius:8px;border:0;background:#fff;display:none}

.qr-area{display:flex;gap:12px;align-items:center;flex-direction:column}
.qr-badge{padding:12px;background:#0b1b2b;border-radius:12px;border:1px solid rgba(255,255,255,0.035);box-shadow:0 10px 20px rgba(0,0,0,0.45)}
canvas.qr{background:#fff;border-radius:10px;padding:8px;display:block}

.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.controls .btn{font-size:14px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.06);color:#fff}

.issued-list{margin-top:12px;max-height:300px;overflow:auto;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02)}
.issued-item{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);font-size:13px}
.mini{font-size:12px;color:rgba(255,255,255,0.75)}
.small{font-size:12px}
.flex{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}

#reader{width:100%;max-width:420px;margin-top:12px;border-radius:8px;overflow:hidden;background:#07121a}

.footer{margin-top:14px;text-align:center;color:rgba(255,255,255,0.6);font-size:13px}

/* toast */
.toast{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.85);padding:10px 14px;border-radius:10px;color:#fff;display:none;z-index:9999}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,0.04);padding:8px;text-align:left;font-size:13px}
.small-btn{padding:6px 8px;border-radius:8px;border:0;cursor:pointer;background:rgba(255,255,255,0.05);color:#fff}
.file-input{padding:6px 0}
</style>
</head>
<body>
<header>
  <h1>Certificate Registry DApp ‚Äî Pro</h1>
  <div class="subtitle">Issue ‚Ä¢ Verify ‚Ä¢ Revoke ‚Ä¢ Bulk Issuance ‚Ä¢ QR ‚Ä¢ Local History</div>

  <div class="top-controls">
    <button id="connectBtn" class="btn btn-yellow">üîó Connect Wallet</button>
    <button id="themeBtn" class="btn btn-pill">üåó Theme</button>
  </div>
  <div id="walletStatus" class="status">üß≠ Wallet not connected</div>
</header>

<main>
  <div class="card">
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="issue">Issue</div>
      <div class="tab" data-tab="verify">Verify</div>
      <div class="tab" data-tab="revoke">Revoke</div>
      <div class="tab" data-tab="institution">Institution (Single / CSV)</div>
    </div>

    <div class="grid">
      <!-- LEFT: main forms -->
      <div>
        <!-- ISSUE -->
        <div id="panel-issue" class="panel">
          <div class="field">
            <label>Upload Certificate (PDF) ‚Äî Preview & SHA-256 Hash</label>
            <input id="fileInput" type="file" accept="application/pdf" class="file-input"/>
            <iframe id="pdfPreview" class="iframe-preview"></iframe>
            <div style="margin-top:10px" class="flex">
              <button id="genHashBtn" class="btn">üìÑ Generate Hash</button>
              <button id="issueBtn" class="btn" style="background:var(--accent-yellow);color:#072;font-weight:800">‚úÖ Issue On-Chain</button>
              <div class="right mini" id="issueStatus"></div>
            </div>
          </div>

          <div class="field" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
            <div><label>Student Name</label><input id="studentName" type="text" placeholder="e.g., A. Sharma" /></div>
            <div><label>Course / Program</label><input id="courseName" type="text" placeholder="e.g., Blockchain Fundamentals" /></div>
            <div><label>Institution</label><input id="institutionName" type="text" placeholder="e.g., ABC Institute" /></div>
            <div><label>Grade (0-255)</label><input id="grade" type="text" placeholder="e.g., 85" /></div>
            <div><label>Issue Date</label><input id="issueDate" type="date" /></div>
          </div>

          <div class="field">
            <label>Certificate Hash (0x...)</label>
            <input id="hashInput" type="text" placeholder="0x..." />
            <div class="controls">
              <button id="copyLinkBtn" class="btn">üìã Copy Verify Link</button>
              <button id="downloadQRBtn" class="btn">‚¨áÔ∏è Download QR</button>
              <button id="shareQRBtn" class="btn">üì§ Share QR</button>
            </div>
          </div>

          <div class="field">
            <strong style="color:#fff">üìù Local History</strong>
            <div id="issuedList" class="issued-list mini"></div>
          </div>
        </div>

        <!-- VERIFY -->
        <div id="panel-verify" class="panel" style="display:none">
          <div class="field">
            <label>Enter or Scan Certificate Hash</label>
            <input id="verifyHash" type="text" placeholder="0x..." />
            <div style="margin-top:8px" class="flex">
              <button id="verifyBtn" class="btn">üîç Verify On-Chain</button>
              <button id="startScanBtn" class="btn">üì∑ Start Scan</button>
              <button id="stopScanBtn" class="btn" disabled>üõë Stop</button>
              <div class="right mini" id="verifyStatus"></div>
            </div>

            <div id="reader"></div>
            <pre id="verifyResult" class="mini" style="white-space:pre-wrap;margin-top:8px"></pre>
          </div>
        </div>

        <!-- REVOKE -->
        <div id="panel-revoke" class="panel" style="display:none">
          <div class="field">
            <label>Certificate Hash to Revoke</label>
            <input id="revokeHash" type="text" placeholder="0x..." />
            <div style="margin-top:8px" class="flex">
              <button id="revokeBtn" class="btn" style="background:var(--danger);color:#fff">‚ùå Revoke On-Chain</button>
              <div class="right mini" id="revokeStatus"></div>
            </div>
          </div>
        </div>

        <!-- INSTITUTION (Single/CSV) -->
        <div id="panel-institution" class="panel" style="display:none">
          <div class="field">
            <label>Add Single Student (manual)</label>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
              <input id="inst_name" type="text" placeholder="Student name"/>
              <input id="inst_course" type="text" placeholder="Course"/>
              <input id="inst_institution" type="text" placeholder="Institution"/>
              <input id="inst_grade" type="text" placeholder="Grade (0-255)"/>
              <input id="inst_date" type="date"/>
            </div>
            <div style="margin-top:8px" class="flex">
              <button id="inst_generate" class="btn">Generate Hash</button>
              <button id="inst_issue_single" class="btn" style="background:var(--accent-yellow);color:#072">Issue On-Chain</button>
              <div class="right mini" id="instStatus"></div>
            </div>
          </div>

          <div class="field">
            <label>Bulk CSV Upload (CSV columns: name,course,institution,grade,date,optional_file_path)</label>
            <input id="csvInput" type="file" accept=".csv" class="file-input"/>
            <div style="margin-top:8px" class="flex">
              <button id="csvParseBtn" class="btn">Parse CSV</button>
              <select id="bulkMode" style="width:180px">
                <option value="generate">Generate Only (local)</option>
                <option value="batch">Batch On-Chain (single tx)</option>
                <option value="individual">Issue One-by-One On-Chain</option>
              </select>
              <button id="csvActionBtn" class="btn" style="background:var(--accent-yellow);color:#072">Run</button>
            </div>
            <div id="csvPreview" style="margin-top:10px" class="mini"></div>
          </div>
        </div>

      </div>

      <!-- RIGHT: QR + quick info -->
      <div>
        <div class="qr-area">
          <div class="qr-badge">
            <canvas id="qrCanvas" class="qr" width="220" height="220·É•
220"></canvas>
          </div>

          <div style="width:100%" class="mini">
            <div style="display:flex;gap:8px">
              <div style="flex:1"><strong style="color:#fff">Quick Actions</strong></div>
              <div style="flex:1;text-align:right" id="networkLabel" class="mini"></div>
            </div>

            <div style="margin-top:10px" class="mini">
              Generate a certificate hash, then Issue on-chain (writes hash & metadata). Use Institution tab for CSV/batch issuance.
            </div>
          </div>
        </div>

        <div class="field" style="margin-top:12px">
          <strong style="color:#fff">Live Console</strong>
          <div id="liveConsole" class="mini" style="margin-top:8px;max-height:200px;overflow:auto"></div>
        </div>
      </div>
    </div> <!-- grid -->
  </div> <!-- card -->

  <div class="card" style="margin-top:14px">
    <strong>All Issued Certificates (local)</strong>
    <div id="historyTable" style="margin-top:8px" class="mini"></div>
  </div>

  <div class="footer">Tip: Save as <code>index.html</code>, open in Chrome, allow camera & wallet permissions.</div>
</main>

<div id="toast" class="toast"></div>

<script>
/* =========================
   Contract address + ABI (provided)
   ========================= */
const contractAddress = "0x67F670024Fd099388b4c1009F89918A844701218";
const contractABI = [
	{
		"inputs": [
			{
				"internalType": "bytes32[]",
				"name": "certHashes",
				"type": "bytes32[]"
			},
			{
				"internalType": "string[]",
				"name": "recipientNames",
				"type": "string[]"
			},
			{
				"internalType": "string[]",
				"name": "courseTitles",
				"type": "string[]"
			},
			{
				"internalType": "uint8[]",
				"name": "grades",
				"type": "uint8[]"
			},
			{
				"internalType": "string[]",
				"name": "_ipfsCids",
				"type": "string[]"
			}
		],
		"name": "batchIssueCertificates",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "recipientName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "courseTitle",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "ipfsCid",
				"type": "string"
			}
		],
		"name": "CertificateIssued",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			}
		],
		"name": "CertificateRevoked",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_account",
				"type": "address"
			}
		],
		"name": "grantIssuerRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			},
			{
				"internalType": "string",
				"name": "recipientName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "courseTitle",
				"type": "string"
			},
			{
				"internalType": "uint8",
				"name": "grade",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "_ipfsCid",
				"type": "string"
			}
		],
		"name": "issueCertificate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "IssuerGranted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "IssuerRevoked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			}
		],
		"name": "revokeCertificate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_account",
				"type": "address"
			}
		],
		"name": "revokeIssuerRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "certHash",
				"type": "bytes32"
			}
		],
		"name": "getCertificateDetails",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "issuer",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "issueDate",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "isValid",
						"type": "bool"
					},
					{
						"internalType": "string",
						"name": "recipientName",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "courseTitle",
						"type": "string"
					},
					{
						"internalType": "uint8",
						"name": "grade",
						"type": "uint8"
					},
					{
						"internalType": "string",
						"name": "ipfsCid",
						"type": "string"
					}
				],
				"internalType": "struct CertificateRegistryV2.Certificate",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_issuer",
				"type": "address"
			}
		],
		"name": "getCertificatesByIssuer",
		"outputs": [
			{
				"internalType": "bytes32[]",
				"name": "",
				"type": "bytes32[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isIssuer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

/* =========================
   App State
   ========================= */
let web3, contract, account;
const LS_KEY = 'certs_v3_local';
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* =========================
   Utils: Toast + console
   ========================= */
function showToast(msg, timeout = 3500) {
  const t = $('#toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', timeout);
}
function logLive(msg) {
  const el = $('#liveConsole');
  const time = new Date().toLocaleTimeString();
  el.innerText = `[${time}] ${msg}\n` + el.innerText;
}

/* =========================
   Theme
   ========================= */
$('#themeBtn').addEventListener('click', () => {
  document.documentElement.classList.toggle('light');
  const val = document.documentElement.classList.contains('light') ? 'light' : 'dark';
  localStorage.setItem('dapp_theme', val);
});
(function initTheme() {
  const v = localStorage.getItem('dapp_theme') || 'dark';
  if (v === 'light') document.documentElement.classList.add('light');
})();

/* =========================
   Tabs
   ========================= */
$$('.tab').forEach(t => t.addEventListener('click', () => {
  $$('.tab').forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  $$('.panel').forEach(p => p.style.display = 'none');
  document.getElementById('panel-' + t.dataset.tab).style.display = 'block';
}));

/* expose panels as elements so .panel selection works */
document.querySelectorAll('.tab').forEach(t => t.classList.contains('active') ? null : null);
document.getElementById('panel-issue').style.display = 'block';

/* =========================
   Wallet connect
   ========================= */
$('#connectBtn').addEventListener('click', async () => {
  if (!window.ethereum) {
    showToast('Please install MetaMask');
    return;
  }
  try {
    web3 = new Web3(window.ethereum);
    const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
    account = accs[0];
    contract = new web3.eth.Contract(contractABI, contractAddress);
    $('#connectBtn').innerText = '‚úÖ Connected';
    $('#walletStatus').innerText = 'üü¢ Connected: ' + account;
    const netId = await web3.eth.net.getId();
    $('#networkLabel').innerText = 'Network: ' + netId;
    logLive('Wallet connected: ' + account);
    window.ethereum.on('accountsChanged', (accs) => {
      account = accs[0];
      $('#walletStatus').innerText = 'üü¢ Connected: ' + account;
    });
    window.ethereum.on('chainChanged', () => location.reload());
    renderIssued();
  } catch (e) {
    console.error(e);
    showToast('Wallet connection failed: ' + (e.message || e));
    logLive('Connect failed: ' + (e.message || e));
  }
});

/* =========================
   SHA256 Hash generation (PDF)
   ========================= */
$('#genHashBtn').addEventListener('click', async () => {
  const file = $('#fileInput').files[0];
  if (!file) return alert('Please select a PDF first.');
  try {
    $('#pdfPreview').src = URL.createObjectURL(file);
    $('#pdfPreview').style.display = 'block';
    const ab = await file.arrayBuffer();
    const digest = await crypto.subtle.digest('SHA-256', ab);
    const arr = Array.from(new Uint8Array(digest));
    const hex = '0x' + arr.map(b => b.toString(16).padStart(2, '0')).join('');
    $('#hashInput').value = hex;
    drawQRCode(hex);
    setMini('issueStatus', 'Hash generated');
    logLive('Hash generated: ' + hex);
  } catch (e) {
    console.error(e);
    showToast('Hash error');
  }
});

function setMini(id, txt) {
  const el = document.getElementById(id);
  if (el) el.innerText = txt;
}

/* =========================
   Draw QR
   ========================= */
function drawQRCode(text) {
  if (!text) return;
  try {
    QRCode.toCanvas($('#qrCanvas'), text, { width: 220, margin: 1 }, err => {
      if (err) console.error(err);
    });
  } catch (e) {
    console.error(e);
  }
}

/* mirror hash to other inputs */
$('#hashInput').addEventListener('input', (e) => {
  const v = e.target.value.trim();
  if (/^0x[0-9a-fA-F]{64}$/.test(v)) {
    $('#verifyHash').value = v;
    $('#revokeHash').value = v;
    drawQRCode(v);
  }
});

/* =========================
   Local Storage helpers
   ========================= */
function getLocal() {
  try {
    return JSON.parse(localStorage.getItem(LS_KEY) || '[]');
  } catch {
    return [];
  }
}
function saveLocal(entry) {
  const arr = getLocal();
  arr.unshift(entry);
  localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0, 1000)));
}
function renderIssued() {
  const items = getLocal();
  const container = $('#issuedList');
  container.innerHTML = '';
  if (!items.length) {
    container.innerHTML = '<div class="mini">No local records yet</div>';
    renderHistoryTable();
    return;
  }
  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 'issued-item';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong style="color:#fff">${it.name || '‚Äî'}</strong><div class="mini">${it.course || '‚Äî'} ‚Ä¢ ${it.institution || '‚Äî'}</div></div>
        <div class="mini">${new Date(it.ts || Date.now()).toLocaleString()}</div>
      </div>
      <div class="mini" style="margin-top:8px;word-break:break-all">${it.hash}</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="small-btn" data-act="copy" data-h="${it.hash}">Copy Link</button>
        <button class="small-btn" data-act="qr" data-h="${it.hash}">Show QR</button>
        <button class="small-btn" data-act="verify" data-h="${it.hash}">Verify</button>
        <button class="small-btn" data-act="revoke" data-h="${it.hash}">Revoke</button>
      </div>
      <div class="mini" style="margin-top:6px">${it.txHash ? ('tx:' + it.txHash) : ''}${it.revoked ? (' ‚Ä¢ REVOKED') : ''}</div>
    `;
    container.appendChild(div);
  });

  container.querySelectorAll('button').forEach(b => {
    b.onclick = async (ev) => {
      const act = ev.currentTarget.dataset.act;
      const h = ev.currentTarget.dataset.h;
      if (act === 'copy') {
        navigator.clipboard.writeText(buildVerifyURL(h));
        showToast('Link copied');
      } else if (act === 'qr') {
        $('#hashInput').value = h;
        drawQRCode(h);
      } else if (act === 'verify') {
        $('#verifyHash').value = h;
        $$('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.tab[data-tab="verify"]').classList.add('active');
        $$('.panel').forEach(p => p.style.display = 'none');
        document.getElementById('panel-verify').style.display = 'block';
        $('#verifyBtn').click();
      } else if (act === 'revoke') {
        $('#revokeHash').value = h;
        $$('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.tab[data-tab="revoke"]').classList.add('active');
        $$('.panel').forEach(p => p.style.display = 'none');
        document.getElementById('panel-revoke').style.display = 'block';
        $('#revokeBtn').click();
      }
    };
  });

  renderHistoryTable();
}

/* history table (bottom) */
function renderHistoryTable() {
  const items = getLocal();
  const container = $('#historyTable');
  if (!items.length) {
    container.innerHTML = '<div class="mini">No history</div>';
    return;
  }
  let html = '<table class="table"><thead><tr><th>When</th><th>Recipient</th><th>Course</th><th>Hash</th><th>Actions</th></tr></thead><tbody>';
  items.forEach(it => {
    html += `<tr><td>${new Date(it.ts || Date.now()).toLocaleString()}</td><td>${it.name || '‚Äî'}</td><td>${it.course || '‚Äî'}</td><td style="word-break:break-all">${it.hash}</td>
      <td><button class="small-btn" onclick="navigator.clipboard.writeText('${buildVerifyURL(it.hash)}')">Copy</button>
          <button class="small-btn" onclick="document.getElementById('hashInput').value='${it.hash}'; drawQRCode('${it.hash}')">QR</button>
          <button class="small-btn" onclick="document.getElementById('verifyHash').value='${it.hash}'; document.querySelector('.tab[data-tab=verify]').click(); setTimeout(()=>document.getElementById('verifyBtn').click(),400)">Verify</button></td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* =========================
   Build verify link
   ========================= */
function buildVerifyURL(hash) {
  return location.origin + location.pathname + '?certHash=' + encodeURIComponent(hash);
}

/* =========================
   Issue On-chain (single)
   ========================= */
$('#issueBtn').addEventListener('click', async () => {
  if (!contract || !account) {
    showToast('Connect wallet first');
    return;
  }
  const hash = $('#hashInput').value.trim();
  if (!/^0x[0-9a-fA-F]{64}$/.test(hash)) {
    alert('Hash must be 0x + 64 hex chars. Generate from PDF.');
    return;
  }
  const recipient = $('#studentName').value.trim() || '‚Äî';
  const course = $('#courseName').value.trim() || '‚Äî';
  const institution = $('#institutionName').value.trim() || '‚Äî';
  let grade = parseInt($('#grade').value, 10);
  if (Number.isNaN(grade)) grade = 0;
  if (grade < 0) grade = 0;
  if (grade > 255) grade = 255;
  const ipfsCid = "";
  try {
    setMini('issueStatus', 'Sending tx...');
    logLive('Issuing certificate: ' + hash);
    const gas = await contract.methods.issueCertificate(hash, recipient, course, grade, ipfsCid).estimateGas({ from: account });
    const tx = await contract.methods.issueCertificate(hash, recipient, course, grade, ipfsCid).send({ from: account, gas: Math.floor(gas * 1.5) });
    showToast('Issued on-chain: ' + tx.transactionHash, 5000);
    setMini('issueStatus', 'Issued: ' + tx.transactionHash);
    const meta = { hash, name: recipient, course, institution, grade, ts: Date.now(), txHash: tx.transactionHash };
    saveLocal(meta);
    renderIssued();
    logLive('Issue tx: ' + tx.transactionHash);
  } catch (e) {
    console.error(e);
    showToast('Issue failed: ' + (e.message || e));
    setMini('issueStatus', 'Error');
    logLive('Issue failed: ' + (e.message || e));
  }
});

/* =========================
   Verify (getCertificateDetails)
   ========================= */
$('#verifyBtn').addEventListener('click', async () => {
  if (!contract) {
    showToast('Connect wallet to verify (calls node)');
    return;
  }
  const hash = $('#verifyHash').value.trim();
  if (!/^0x[0-9a-fA-F]{64}$/.test(hash)) {
    alert('Enter 0x + 64 hex chars');
    return;
  }
  try {
    setMini('verifyStatus', 'Checking...');
    logLive('Verifying: ' + hash);
    const details = await contract.methods.getCertificateDetails(hash).call();
    const issuer = details.issuer || details[0];
    const issueDate = Number(details.issueDate || details[1] || 0);
    const isValid = (details.isValid !== undefined) ? details.isValid : details[2];
    const recipientName = details.recipientName || details[3] || '';
    const courseTitle = details.courseTitle || details[4] || '';
    const grade = (details.grade !== undefined) ? details.grade : details[5];
    const ipfsCid = details.ipfsCid || details[6] || '';
    const validText = isValid ? '‚úÖ VALID (on-chain)' : '‚ùå NOT VALID';
    const issueWhen = issueDate ? new Date(issueDate * 1000).toLocaleString() : '‚Äî';
    const localRecord = getLocal().find(item => item.hash === hash);
    const csvNote = localRecord && !localRecord.file ? '\nNote: This is a randomly generated hash (CSV-based, not PDF-derived)' : '';
    const out = `${validText}\nIssuer: ${issuer}\nIssued: ${issueWhen}\nRecipient: ${recipientName}\nCourse: ${courseTitle}\nGrade: ${grade}\nIPFS CID: ${ipfsCid}${csvNote}`;
    $('#verifyResult').innerText = out;
    setMini('verifyStatus', 'Done');
    logLive('Verify result shown');
  } catch (e) {
    console.error(e);
    showToast('Verify failed: ' + (e.message || e));
    setMini('verifyStatus', 'Error');
    logLive('Verify failed: ' + (e.message || e));
  }
});

/* =========================
   Revoke
   ========================= */
$('#revokeBtn').addEventListener('click', async () => {
  if (!contract || !account) {
    showToast('Connect wallet');
    return;
  }
  const hash = $('#revokeHash').value.trim();
  if (!/^0x[0-9a-fA-F]{64}$/.test(hash)) {
    alert('Enter 0x + 64 hex chars');
    return;
  }
  try {
    setMini('revokeStatus', 'Sending revoke tx...');
    logLive('Revoking: ' + hash);
    const gas = await contract.methods.revokeCertificate(hash).estimateGas({ from: account });
    const tx = await contract.methods.revokeCertificate(hash).send({ from: account, gas: Math.floor(gas * 1.5) });
    showToast('Revoked: ' + tx.transactionHash);
    const list = getLocal();
    const idx = list.findIndex(i => i.hash === hash);
    if (idx > -1) {
      list[idx].revoked = true;
      list[idx].revokeTx = tx.transactionHash;
      localStorage.setItem(LS_KEY, JSON.stringify(list));
      renderIssued();
    }
    setMini('revokeStatus', 'Revoked: ' + tx.transactionHash);
    logLive('Revoke tx: ' + tx.transactionHash);
  } catch (e) {
    console.error(e);
    showToast('Revoke failed: ' + (e.message || e));
    setMini('revokeStatus', 'Error');
    logLive('Revoke failed: ' + (e.message || e));
  }
});

/* =========================
   QR copy / download / share
   ========================= */
$('#copyLinkBtn').addEventListener('click', () => {
  const h = $('#hashInput').value.trim();
  if (!h) {
    showToast('No hash');
    return;
  }
  navigator.clipboard.writeText(buildVerifyURL(h));
  showToast('Link copied');
});
$('#downloadQRBtn').addEventListener('click', () => {
  const c = $('#qrCanvas');
  const a = document.createElement('a');
  a.download = 'certificate_qr.png';
  a.href = c.toDataURL('image/png');
  a.click();
});
$('#shareQRBtn').addEventListener('click', () => {
  const c = $('#qrCanvas');
  c.toBlob(async blob => {
    const file = new File([blob], 'certificate_qr.png', { type: 'image/png' });
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({ files: [file], title: 'Certificate QR' });
    } else {
      showToast('Sharing not supported');
    }
  });
});

/* =========================
   QR scanning (html5-qrcode)
   ========================= */
let html5QrCode = null;
$('#startScanBtn').addEventListener('click', async () => {
  if (html5QrCode) return;
  html5QrCode = new Html5Qrcode("reader");
  try {
    const cams = await Html5Qrcode.getCameras();
    const camId = cams && cams.length ? cams[0].id : null;
    await html5QrCode.start(camId, { fps: 10, qrbox: 250 }, decoded => {
      $('#verifyHash').value = decoded;
      $('#verifyBtn').click();
      html5QrCode.stop().then(() => {
        html5QrCode = null;
        $('#stopScanBtn').disabled = true;
      }).catch(() => {});
    }, err => {});
    $('#stopScanBtn').disabled = false;
    showToast('Scanner started');
  } catch (e) {
    console.error(e);
    showToast('Camera start failed: ' + (e.message || e));
    html5QrCode = null;
    $('#stopScanBtn').disabled = true;
  }
});
$('#stopScanBtn').addEventListener('click', async () => {
  if (!html5QrCode) return;
  try {
    await html5QrCode.stop();
    html5QrCode = null;
    $('#stopScanBtn').disabled = true;
    showToast('Scanner stopped');
  } catch (e) {
    console.warn(e);
  }
});

/* =========================
   Institution Single generate / issue
   ========================= */
$('#inst_generate').addEventListener('click', () => {
  const name = $('#inst_name').value.trim();
  const course = $('#inst_course').value.trim();
  const institution = $('#inst_institution').value.trim();
  const grade = parseInt($('#inst_grade').value, 10) || 0;
  const date = $('#inst_date').value || new Date().toISOString().split('T')[0];
  const rand = crypto.getRandomValues(new Uint8Array(32));
  const hash = '0x' + Array.from(rand).map(b => b.toString(16).padStart(2, '0')).join('');
  $('#hashInput').value = hash;
  drawQRCode(hash);
  setMini('instStatus', 'Hash generated');
  showToast('Hash generated for ' + (name || 'student'));
});
$('#inst_issue_single').addEventListener('click', async () => {
  $('#studentName').value = $('#inst_name').value;
  $('#courseName').value = $('#inst_course').value;
  $('#institutionName').value = $('#inst_institution').value;
  $('#grade').value = $('#inst_grade').value;
  $('#issueDate').value = $('#inst_date').value;
  if (!$('#hashInput').value) {
    showToast('Generate hash first');
    return;
  }
  $('#issueBtn').click();
});

/* =========================
   CSV parse & bulk actions
   ========================= */
let csvRows = [];
$('#csvParseBtn').addEventListener('click', async () => {
  const file = $('#csvInput').files[0];
  if (!file) return alert('Choose CSV file');
  try {
    const text = await file.text();
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
    let start = 0;
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    const hasHeader = headers.some(h => ['name', 'course', 'institution', 'grade', 'date', 'file'].includes(h));
    if (hasHeader) start = 1;
    csvRows = [];
    for (let i = start; i < lines.length; i++) {
      const cols = lines[i].split(',').map(c => c.trim());
      if (hasHeader) {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = cols[idx] || '');
        csvRows.push({
          name: obj.name || obj.recipient || '‚Äî',
          course: obj.course || obj.coursetitle || '‚Äî',
          institution: obj.institution || '‚Äî',
          grade: parseInt(obj.grade, 10) || 0,
          date: obj.date || new Date().toISOString().split('T')[0]
        });
      } else {
        csvRows.push({
          name: cols[0] || '‚Äî',
          course: cols[1] || '‚Äî',
          institution: cols[2] || '‚Äî',
          grade: parseInt(cols[3], 10) || 0,
          date: cols[4] || new Date().toISOString().split('T')[0]
        });
      }
    }
    $('#csvPreview').innerText = `Parsed ${csvRows.length} rows. Sample: ${csvRows[0] ? (csvRows[0].name + ' ‚Äî ' + csvRows[0].course) : ''}`;
    showToast('CSV parsed: ' + csvRows.length + ' rows');
    logLive('CSV parsed: ' + csvRows.length);
  } catch (e) {
    console.error(e);
    showToast('CSV parsing failed: ' + (e.message || e));
    logLive('CSV parsing failed: ' + (e.message || e));
  }
});

$('#csvActionBtn').addEventListener('click', async () => {
  if (!csvRows.length) return alert('No CSV rows parsed');
  const mode = $('#bulkMode').value;
  if (!contract || !account) {
    showToast('Connect wallet first');
    return;
  }
  if (mode === 'generate') {
    csvRows.forEach(r => {
      const rand = crypto.getRandomValues(new Uint8Array(32));
      const hash = '0x' + Array.from(rand).map(b => b.toString(16).padStart(2, '0')).join('');
      const meta = { hash, name: r.name, course: r.course, institution: r.institution, grade: r.grade, ts: Date.now() };
      saveLocal(meta);
    });
    renderIssued();
    showToast('Generated hashes locally for ' + csvRows.length + ' rows');
    logLive('Generated hashes locally for CSV');
  } else if (mode === 'batch') {
    try {
      const hashes = [];
      const names = [];
      const courses = [];
      const grades = [];
      const ipfs = [];
      for (const r of csvRows) {
        const rand = crypto.getRandomValues(new Uint8Array(32));
        const h = '0x' + Array.from(rand).map(b => b.toString(16).padStart(2, '0')).join('');
        hashes.push(h);
        names.push(r.name || '‚Äî');
        courses.push(r.course || '‚Äî');
        let g = parseInt(r.grade, 10);
        if (Number.isNaN(g)) g = 0;
        if (g < 0) g = 0;
        if (g > 255) g = 255;
        grades.push(Number(g));
        ipfs.push('');
      }
      setMini('instStatus', 'Estimating gas...');
      logLive(`Estimating gas for batch issuance of ${hashes.length} certificates`);
      let gas;
      try {
        gas = await contract.methods.batchIssueCertificates(hashes, names, courses, grades, ipfs).estimateGas({ from: account });
      } catch (e) {
        throw new Error('Gas estimation failed: ' + (e.message || e));
      }
      const gasLimit = Math.floor(gas * 1.5);
      setMini('instStatus', `Sending batch tx (${hashes.length} certs)...`);
      logLive(`Sending batchIssueCertificates for ${hashes.length} certs, gas: ${gasLimit}`);
      const tx = await contract.methods.batchIssueCertificates(hashes, names, courses, grades, ipfs).send({ from: account, gas: gasLimit });
      showToast(`Batch issued: ${tx.transactionHash}`, 6000);
      for (let i = 0; i < hashes.length; i++) {
        saveLocal({
          hash: hashes[i],
          name: names[i],
          course: courses[i],
          institution: csvRows[i].institution,
          grade: grades[i],
          ts: Date.now(),
          txHash: tx.transactionHash
        });
      }
      renderIssued();
      setMini('instStatus', `Batch tx: ${tx.transactionHash}`);
      logLive(`Batch tx successful: ${tx.transactionHash}`);
    } catch (e) {
      console.error(e);
      let errorMsg = e.message || e;
      if (errorMsg.includes('gas')) {
        errorMsg = 'Transaction failed: insufficient gas. Try reducing the number of certificates or increasing gas limit in MetaMask.';
      } else if (errorMsg.includes('revert')) {
        errorMsg = 'Transaction reverted: ensure you have issuer permissions and sufficient funds.';
      }
      showToast(`Batch failed: ${errorMsg}`);
      setMini('instStatus', 'Error');
      logLive(`Batch failed: ${errorMsg}`);
    }
  } else if (mode === 'individual') {
    let successCount = 0;
    for (const r of csvRows) {
      try {
        const rand = crypto.getRandomValues(new Uint8Array(32));
        const h = '0x' + Array.from(rand).map(b => b.toString(16).padStart(2, '0')).join('');
        const name = r.name || '‚Äî';
        const course = r.course || '‚Äî';
        let g = parseInt(r.grade, 10);
        if (Number.isNaN(g)) g = 0;
        if (g > 255) g = 255;
        setMini('instStatus', `Issuing: ${name}`);
        logLive(`Issuing individual: ${name}`);
        const gas = await contract.methods.issueCertificate(h, name, course, Number(g), "").estimateGas({ from: account });
        const tx = await contract.methods.issueCertificate(h, name, course, Number(g), "").send({ from: account, gas: Math.floor(gas * 1.5) });
        saveLocal({ hash: h, name, course, institution: r.institution, grade: g, ts: Date.now(), txHash: tx.transactionHash });
        renderIssued();
        showToast(`Issued: ${name} (${tx.transactionHash})`, 4000);
        logLive(`Issued individual tx: ${tx.transactionHash}`);
        successCount++;
      } catch (e) {
        console.error(e);
        let errorMsg = e.message || e;
        if (errorMsg.includes('gas')) {
          errorMsg = 'Insufficient gas for ' + r.name;
        } else if (errorMsg.includes('revert')) {
          errorMsg = 'Transaction reverted for ' + r.name + ': check issuer permissions';
        }
        showToast(`Issue failed for ${r.name}: ${errorMsg}`);
        logLive(`Issue failed for ${r.name}: ${errorMsg}`);
      }
    }
    setMini('instStatus', `Completed: ${successCount}/${csvRows.length} issued`);
    logLive(`Individual issuance completed: ${successCount}/${csvRows.length}`);
  }
});

/* =========================
   Deep-link auto verify
   ========================= */
(function autoVerifyFromURL() {
  const p = new URLSearchParams(location.search);
  const h = p.get('certHash');
  if (h) {
    $$('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-tab="verify"]').classList.add('active');
    $$('.panel').forEach(p => p.style.display = 'none');
    document.getElementById('panel-verify').style.display = 'block';
    $('#verifyHash').value = h;
    drawQRCode(h);
    setTimeout(() => $('#verifyBtn').click(), 700);
  }
})();

/* =========================
   Init
   ========================= */
renderIssued();
drawQRCode('Certificate Registry DApp');
logLive('App initialized');
</script>
</body>
</html>
