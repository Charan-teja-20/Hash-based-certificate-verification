<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NFT Credential DApp</title>

<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
:root{
  --bg-1:#071A2B; --bg-2:#0E2B44;
  --card: rgba(255,255,255,0.04);
  --muted: rgba(255,255,255,0.78);
  --accent-yellow:#ffd24a; --accent-yellow-2:#ffcf3b;
  --danger:#ff6b6b; --success:#4ade80;
}
:root.light {
  --bg-1: #f0f4f8; --bg-2: #ffffff;
  --card: rgba(0,0,0,0.04);
  --muted: #333;
  --accent-yellow: #f59e0b; --accent-yellow-2: #d97706;
  --danger:#ef4444; --success:#22c55e;
}
.light h1, .light .tab.active, .light strong, .light .btn-yellow, .light #walletStatus { color: #1e293b; }
.light .subtitle, .light label, .light .mini, .light .footer, .light .tab { color: #475569; }
.light input, .light select, .light textarea { background: rgba(0,0,0,0.02); border-color: rgba(0,0,0,0.1); color: #1e293b; }
.light .qr-badge { background: #e2e8f0; }
.light .card { background: linear-gradient(180deg,rgba(255,255,255,0.8), #fff); border-color: rgba(0,0,0,0.08); }
.light .controls .btn, .light .small-btn { background: rgba(0,0,0,0.06); color: #1e293b; }
.light #liveConsole { color: #334155; }

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Space Grotesk',system-ui,Segoe UI,Roboto,sans-serif;color:var(--muted);background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
header{padding:18px 14px;text-align:center}
h1{margin:0;color:#fff;font-family:'Fredoka One',cursive;font-size:30px}
.subtitle{color:rgba(255,255,255,0.75);margin-top:6px;font-size:13px}
.top-controls{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px;flex-wrap:wrap}
.btn{border:0;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:700}
.btn-yellow{background:linear-gradient(180deg,var(--accent-yellow),var(--accent-yellow-2));color:#0b2735}
.btn-pill{background:#fff;color:#0b2740;padding:8px 12px;border-radius:20px}
.status{margin-top:8px;color:#ffd;font-weight:600;font-size:13px}
main{max-width:1150px;margin:16px auto;padding:0 12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 18px 40px rgba(0,0,0,0.35)}
.tabs{display:flex;gap:8px;padding:8px;border-radius:12px;margin-bottom:12px}
.tab{flex:1;text-align:center;padding:12px;border-radius:12px;cursor:pointer;background:rgba(255,255,255,0.03);color:#cfe6ff;font-weight:700}
.tab.active{background:rgba(255,255,255,0.06);color:#fff}
.grid{display:grid;grid-template-columns:1fr 420px;gap:14px;align-items:start}
@media (max-width:960px){ .grid{grid-template-columns:1fr} }
.field{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);color:var(--muted);margin-bottom:10px}
label{display:block;font-size:13px;margin-bottom:8px;color:rgba(255,255,255,0.9)}
input[type="text"], input[type="number"], input[type="file"], select, textarea {
  width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;
}
.qr-area{display:flex;gap:12px;align-items:center;flex-direction:column}
.qr-badge{padding:12px;background:#0b1b2b;border-radius:12px;border:1px solid rgba(255,255,255,0.035);box-shadow:0 10px 20px rgba(0,0,0,0.45)}
canvas.qr{background:#fff;border-radius:10px;padding:8px;display:block}
.issued-list{margin-top:12px;max-height:300px;overflow:auto;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02)}
.issued-item{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);font-size:13px}
.mini{font-size:12px;color:rgba(255,255,255,0.75)}
.flex{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}
.footer{margin-top:14px;text-align:center;color:rgba(255,255,255,0.6);font-size:13px}
.toast{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.85);padding:10px 14px;border-radius:10px;color:#fff;display:none;z-index:9999}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,0.04);padding:8px;text-align:left;font-size:13px}
.small-btn{padding:6px 8px;border-radius:8px;border:0;cursor:pointer;background:rgba(255,255,255,0.05);color:#fff}
.file-input{padding:6px 0}
</style>
</head>
<body>
<header>
  <h1>NFT Credential DApp</h1>
  <div class="subtitle">Issue ERC721 Credentials ‚Ä¢ Verify ‚Ä¢ Revoke</div>

  <div class="top-controls">
    <button id="connectBtn" class="btn btn-yellow">üîó Connect Wallet</button>
    <button id="themeBtn" class="btn btn-pill">üåó Theme</button>
  </div>
  <div id="walletStatus" class="status">üß≠ Wallet not connected</div>
</header>

<main>
  <div class="card">
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="issue">Issue</div>
      <div class="tab" data-tab="verify">Verify</div>
      <div class="tab" data-tab="revoke">Revoke</div>
      <div class="tab" data-tab="institution">Institution (Bulk)</div>
    </div>

    <div class="grid">
      <div>
        <div id="panel-issue" class="panel">
          <div class="field">
            <label>Student Address</label>
            <input id="studentAddress" type="text" placeholder="0x..." />
          </div>
          <div class="field">
            <label>Token URI (Metadata Link)</label>
            <input id="tokenURI" type="text" placeholder="https://gateway.pinata.cloud/ipfs/..." />
            <div style="margin-top:10px" class="flex">
              <button id="issueBtn" class="btn" style="background:var(--accent-yellow);color:#072;font-weight:800">‚úÖ Issue Credential</button>
              <div class="right mini" id="issueStatus"></div>
            </div>
          </div>
           <div class="field">
            <strong style="color:#fff">üìù Recently Issued (Local History)</strong>
            <div id="issuedList" class="issued-list mini"></div>
          </div>
        </div>

        <div id="panel-verify" class="panel" style="display:none">
          <div class="field">
            <label>Enter Credential Token ID</label>
            <input id="verifyTokenId" type="number" placeholder="e.g., 1" />
            <div style="margin-top:8px" class="flex">
              <button id="verifyBtn" class="btn">üîç Verify On-Chain</button>
              <div class="right mini" id="verifyStatus"></div>
            </div>
            <pre id="verifyResult" class="mini" style="white-space:pre-wrap;margin-top:8px"></pre>
          </div>
        </div>

        <div id="panel-revoke" class="panel" style="display:none">
          <div class="field">
            <label>Credential Token ID to Revoke</label>
            <input id="revokeTokenId" type="number" placeholder="e.g., 1" />
            <div style="margin-top:8px" class="flex">
              <button id="revokeBtn" class="btn" style="background:var(--danger);color:#fff">‚ùå Revoke Credential</button>
              <div class="right mini" id="revokeStatus"></div>
            </div>
          </div>
        </div>

        <div id="panel-institution" class="panel" style="display:none">
          <div class="field">
            <label>Bulk CSV Upload (columns: student_address,token_uri)</label>
            <input id="csvInput" type="file" accept=".csv" class="file-input"/>
            <div style="margin-top:8px" class="flex">
                <button id="csvParseBtn" class="btn">üìÑ Parse CSV</button>
                <button id="csvIssueBtn" class="btn" style="background:var(--accent-yellow);color:#072">üöÄ Issue All (One-by-One)</button>
            </div>
            <div id="csvPreview" style="margin-top:10px; max-height: 150px; overflow-y: auto;" class="mini"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="qr-area">
          <div class="qr-badge">
            <canvas id="qrCanvas" class="qr" width="220" height="220"></canvas>
          </div>
          <div class="field" style="width:100%;">
            <label>Token ID for QR</label>
            <input id="qrTokenIdInput" type="number" placeholder="Enter Token ID to generate QR" />
          </div>
          <div style="width:100%; text-align:center;" class="mini">
             Enter a Token ID to generate a QR code for verification.
          </div>
        </div>
        <div class="field" style="margin-top:12px">
          <strong style="color:#fff">Live Console</strong>
          <div id="liveConsole" class="mini" style="margin-top:8px;max-height:200px;overflow:auto"></div>
        </div>
      </div>
    </div> </div> <div class="card" style="margin-top:14px">
    <strong>All Issued Credentials (Local History)</strong>
    <div id="historyTable" style="margin-top:8px" class="mini"></div>
  </div>

  <div class="footer">DApp updated to support ERC721 Credential Contract.</div>
</main>

<div id="toast" class="toast"></div>

<script>
/* =========================
   NEW Contract address + ABI
   ========================= */
const contractAddress = "0x17f405356cc1101E1e04f31901d4eAcaaBb7A0C4";
const contractABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			}
		],
		"name": "addIssuer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721IncorrectOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721InsufficientApproval",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "approver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidApprover",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOperator",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidReceiver",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "ERC721InvalidSender",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721NonexistentToken",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "student",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "tokenURI",
				"type": "string"
			}
		],
		"name": "issueCredential",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "approved",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "ApprovalForAll",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_fromTokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_toTokenId",
				"type": "uint256"
			}
		],
		"name": "BatchMetadataUpdate",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "_tokenId",
				"type": "uint256"
			}
		],
		"name": "MetadataUpdate",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			}
		],
		"name": "removeIssuer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "revokeCredential",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "setApprovalForAll",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "authorizedIssuers",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getApproved",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "isApprovedForAll",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "nextTokenId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ownerOf",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "revoked",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes4",
				"name": "interfaceId",
				"type": "bytes4"
			}
		],
		"name": "supportsInterface",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "tokenURI",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "verifyCredential",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

/* =========================
   App State
   ========================= */
let web3, contract, account;
const LS_KEY = 'credential_nft_local';
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* =========================
   Utils: Toast + console
   ========================= */
function showToast(msg, timeout=3500){
  const t = $('#toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(()=> t.style.display='none', timeout);
}
function logLive(msg){
  const el = $('#liveConsole');
  const time = new Date().toLocaleTimeString();
  el.innerText = `[${time}] ${msg}\n` + el.innerText;
}

/* =========================
   Theme
   ========================= */
$('#themeBtn').addEventListener('click', ()=>{
  document.documentElement.classList.toggle('light');
  const val = document.documentElement.classList.contains('light') ? 'light' : 'dark';
  localStorage.setItem('dapp_theme', val);
});
(function initTheme(){ const v = localStorage.getItem('dapp_theme') || 'dark'; if(v==='light') document.documentElement.classList.add('light'); })();

/* =========================
   Tabs
   ========================= */
$$('.tab').forEach(t=> t.addEventListener('click', () => {
  $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  $$('.panel').forEach(p=>p.style.display='none');
  document.getElementById('panel-' + t.dataset.tab).style.display = 'block';
}));

/* =========================
   Wallet connect
   ========================= */
$('#connectBtn').addEventListener('click', async ()=>{
  if(!window.ethereum){ alert('Please install MetaMask'); return; }
  try {
    web3 = new Web3(window.ethereum);
    const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
    account = accs[0];
    contract = new web3.eth.Contract(contractABI, contractAddress);
    $('#connectBtn').innerText = '‚úÖ Connected';
    $('#walletStatus').innerText = 'üü¢ Connected: ' + account.substring(0,6) + '...' + account.substring(38);
    const netId = await web3.eth.net.getId();
    logLive('Wallet connected: ' + account);
    window.ethereum.on('accountsChanged', (accs)=> { account = accs[0]; $('#walletStatus').innerText = 'üü¢ Connected: ' + account.substring(0,6) + '...' + account.substring(38); });
    window.ethereum.on('chainChanged', ()=> location.reload());
    renderIssued();
  } catch(e){
    console.error(e); showToast('Wallet connection failed: ' + (e.message||e)); logLive('Connect failed: ' + (e.message||e));
  }
});

/* =========================
   Draw QR
   ========================= */
function drawQRCode(text){
  if(!text) return;
  try { QRCode.toCanvas($('#qrCanvas'), text, { width:220, margin:1 }, err => { if(err) console.error(err); }); } catch(e){ console.error(e); }
}
$('#qrTokenIdInput').addEventListener('input', (e) => {
    const tokenId = e.target.value;
    if (tokenId && tokenId.length > 0) {
        // Create a verification URL for the QR code
        const url = `${window.location.origin}${window.location.pathname}?verifyTokenId=${tokenId}`;
        drawQRCode(url);
    }
});


/* =========================
   Local Storage helpers
   ========================= */
function getLocal(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{return []} }
function saveLocal(entry){ const arr=getLocal(); arr.unshift(entry); localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0,1000))); }

function renderIssued(){
  const items = getLocal();
  const container = $('#issuedList');
  container.innerHTML = '';
  if(!items.length){ container.innerHTML = '<div class="mini">No local records yet</div>'; renderHistoryTable(); return; }
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='issued-item';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong style="color:#fff">Token ID: ${it.tokenId}</strong><div class="mini">To: ${it.studentAddress.substring(0,12)}...</div></div>
        <div class="mini">${new Date(it.ts||Date.now()).toLocaleDateString()}</div>
      </div>
      <div class="mini" style="margin-top:4px;word-break:break-all">URI: ${it.tokenURI}</div>
    `;
    container.appendChild(div);
  });
  renderHistoryTable();
}

function renderHistoryTable(){
  const items=getLocal();
  const container = $('#historyTable'); if(!items.length){ container.innerHTML='<div class="mini">No history</div>'; return; }
  let html = '<table class="table"><thead><tr><th>When</th><th>Token ID</th><th>Student Address</th><th>Token URI</th><th>Actions</th></tr></thead><tbody>';
  items.forEach(it=>{
    html += `<tr>
        <td>${new Date(it.ts||Date.now()).toLocaleString()}</td>
        <td>${it.tokenId}</td>
        <td style="word-break:break-all">${it.studentAddress}</td>
        <td style="word-break:break-all">${it.tokenURI}</td>
        <td><button class="small-btn" onclick="document.getElementById('verifyTokenId').value='${it.tokenId}'; document.querySelector('.tab[data-tab=verify]').click(); setTimeout(()=>document.getElementById('verifyBtn').click(),200)">Verify</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* =========================
   Issue Credential
   ========================= */
$('#issueBtn').addEventListener('click', async ()=>{
  if(!contract || !account){ showToast('Connect wallet first'); return; }
  const studentAddress = $('#studentAddress').value.trim();
  const tokenURI = $('#tokenURI').value.trim();
  if(!web3.utils.isAddress(studentAddress)){ alert('Please enter a valid student address.'); return; }
  if(!tokenURI){ alert('Please enter a token URI.'); return; }

  try {
    setMini('issueStatus','Sending tx...');
    logLive(`Issuing credential to ${studentAddress}`);
    
    // Listen for the Transfer event to get the tokenId
    let tokenId = 'N/A';
    contract.once('Transfer', { filter: { to: studentAddress }, fromBlock: 'latest' }, (error, event) => {
        if (event && event.returnValues) {
            tokenId = event.returnValues.tokenId;
            logLive(`Credential issued with Token ID: ${tokenId}`);
            const meta = { tokenId, studentAddress, tokenURI, ts: Date.now() };
            saveLocal(meta); renderIssued();
        }
    });

    const tx = await contract.methods.issueCredential(studentAddress, tokenURI).send({ from: account });
    showToast('Transaction sent: ' + tx.transactionHash, 5000);
    setMini('issueStatus','Issued tx: ' + tx.transactionHash.substring(0,14) + '...');
    logLive('Issue tx: ' + tx.transactionHash);

  } catch(e){ console.error(e); showToast('Issue failed: ' + (e.message||e)); setMini('issueStatus','Error'); logLive('Issue failed: ' + (e.message||e)); }
});

/* =========================
   Verify Credential
   ========================= */
$('#verifyBtn').addEventListener('click', async ()=>{
  if(!contract){ showToast('Connect wallet to verify'); return; }
  const tokenId = $('#verifyTokenId').value;
  if(!tokenId || parseInt(tokenId) < 0){ alert('Please enter a valid Token ID.'); return; }
  try {
    setMini('verifyStatus','Checking...');
    logLive('Verifying Token ID: ' + tokenId);

    const isValid = await contract.methods.verifyCredential(tokenId).call();
    const owner = await contract.methods.ownerOf(tokenId).call();
    const uri = await contract.methods.tokenURI(tokenId).call();
    
    const validText = isValid ? '‚úÖ CREDENTIAL VALID' : '‚ùå CREDENTIAL NOT VALID (or Revoked)';
    const out = `${validText}\n------------------\nToken ID: ${tokenId}\nOwner: ${owner}\nMetadata: ${uri}`;
    $('#verifyResult').innerText = out;
    setMini('verifyStatus','Done');
    logLive('Verify result shown for Token ID ' + tokenId);
  } catch(e){
    console.error(e);
    $('#verifyResult').innerText = 'Error verifying this token. It might not exist.';
    showToast('Verify failed: ' + (e.message||e));
    setMini('verifyStatus','Error');
    logLive('Verify failed for Token ID ' + tokenId + ': ' + (e.message||e));
  }
});

/* =========================
   Revoke Credential
   ========================= */
$('#revokeBtn').addEventListener('click', async ()=>{
  if(!contract || !account){ showToast('Connect wallet'); return; }
  const tokenId = $('#revokeTokenId').value;
  if(!tokenId || parseInt(tokenId) < 0){ alert('Please enter a valid Token ID to revoke.'); return; }
  try {
    setMini('revokeStatus','Sending revoke tx...');
    logLive('Revoking Token ID: ' + tokenId);
    const tx = await contract.methods.revokeCredential(tokenId).send({ from: account });
    showToast('Revoked: ' + tx.transactionHash);
    setMini('revokeStatus','Revoked in tx: ' + tx.transactionHash.substring(0, 14) + '...');
    logLive('Revoke tx: ' + tx.transactionHash);
  } catch(e){ console.error(e); showToast('Revoke failed: ' + (e.message||e)); setMini('revokeStatus','Error'); logLive('Revoke failed: ' + (e.message||e)); }
});


/* =========================
   CSV Processing
   ========================= */
let csvRows = [];
$('#csvParseBtn').addEventListener('click', async () => {
    const file = $('#csvInput').files[0];
    if (!file) return alert('Choose CSV file');
    const text = await file.text();
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
    let start = 0;
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    const hasHeader = headers.includes('student_address') && headers.includes('token_uri');
    if (hasHeader) { start = 1; }

    csvRows = [];
    for (let i = start; i < lines.length; i++) {
        const cols = lines[i].split(',').map(c => c.trim());
        let rowData = {};
        if (hasHeader) {
            const obj = {};
            headers.forEach((h, idx) => obj[h] = cols[idx] || '');
            rowData = { student_address: obj.student_address, token_uri: obj.token_uri };
        } else {
            rowData = { student_address: cols[0] || '', token_uri: cols[1] || '' };
        }
        if (web3.utils.isAddress(rowData.student_address)) {
            csvRows.push(rowData);
        }
    }
    $('#csvPreview').innerText = `Parsed ${csvRows.length} valid rows. Ready to issue.`;
    showToast(`CSV parsed: ${csvRows.length} rows`);
    logLive(`CSV parsed: ${csvRows.length} rows`);
});

$('#csvIssueBtn').addEventListener('click', async () => {
    if (!csvRows.length) return alert('No valid CSV rows parsed.');
    if (!contract || !account) { showToast('Connect wallet first'); return; }

    logLive(`Starting bulk issue of ${csvRows.length} credentials...`);
    for (let i = 0; i < csvRows.length; i++) {
        const row = csvRows[i];
        try {
            showToast(`Issuing ${i + 1}/${csvRows.length} to ${row.student_address.substring(0,8)}...`);
            
            // Listen for event to save data with correct tokenId
            contract.once('Transfer', { filter: { to: row.student_address }, fromBlock: 'latest' }, (error, event) => {
                if (event && event.returnValues) {
                    const tokenId = event.returnValues.tokenId;
                    saveLocal({ tokenId, studentAddress: row.student_address, tokenURI: row.token_uri, ts: Date.now() });
                    renderIssued();
                }
            });

            const tx = await contract.methods.issueCredential(row.student_address, row.token_uri).send({ from: account });
            logLive(`Issued #${i + 1} in tx: ${tx.transactionHash}`);
            await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
        } catch (e) {
            console.error(e);
            showToast(`Failed to issue to ${row.student_address}: ${e.message}`);
            logLive(`Failed to issue #${i + 1} to ${row.student_address}`);
            if (confirm("An error occurred. Stop bulk issuing?")) {
                break;
            }
        }
    }
    logLive('Bulk issuing finished.');
    showToast('Bulk issuing finished.');
});

/* =========================
   Deep-link auto verify
   ========================= */
(function autoVerifyFromURL(){
  const p = new new URLSearchParams(window.location.search);
  const tokenId = p.get('verifyTokenId');
  if(tokenId){
    $$('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelector('.tab[data-tab="verify"]').classList.add('active');
    $$('.panel').forEach(p=>p.style.display='none');
    $('#panel-verify').style.display='block';
    $('#verifyTokenId').value = tokenId;
    
    // Auto-click verify if wallet is already connected
    const connectInterval = setInterval(() => {
        if(contract) {
            $('#verifyBtn').click();
            clearInterval(connectInterval);
        }
    }, 500);
  }
})();

/* =========================
   Init
   ========================= */
renderIssued();
drawQRCode('NFT Credential DApp');
logLive('App initialized for NFT Credential Contract');

</script>
</body>
</html>
