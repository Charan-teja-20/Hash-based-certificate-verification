<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Certificate Registry DApp ‚Äî Connected</title>

<!-- Fonts & libs -->
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>

<style>
  :root{
    --bg-1: #071A2B; --bg-2: #0E2B44;
    --card: rgba(255,255,255,0.04);
    --muted: rgba(255,255,255,0.75);
    --accent-yellow: #ffd24a; --accent-yellow-2: #ffcf3b;
    --glass: rgba(255,255,255,0.03);
    --border: rgba(255,255,255,0.06);
    --success: #4ade80; --danger: #ff6b6b;
  }
  body{ margin:0; font-family:'Space Grotesk',system-ui,Segoe UI,Roboto,sans-serif;
    background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color:var(--muted); padding:20px; -webkit-font-smoothing:antialiased;}
  header{text-align:center;margin-bottom:16px}
  h1{margin:0;color:#fff;font-family:'Fredoka One',cursive;font-size:34px}
  .subtitle{color:rgba(255,255,255,0.8);margin-top:6px;font-size:14px}
  .top-controls{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:14px}
  .btn{border:0;cursor:pointer;border-radius:12px;padding:10px 16px;font-weight:700}
  .btn-yellow{background:linear-gradient(180deg,var(--accent-yellow),var(--accent-yellow-2));color:#12202a}
  .btn-pill{background:#ffffff;color:#0b2740;padding:8px 12px;border-radius:20px}
  .status{margin-top:10px;color:#ffd;font-weight:600}
  main{max-width:1100px;margin:18px auto}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:18px;border:1px solid var(--border);box-shadow:0 20px 50px rgba(2,10,20,0.35)}
  .tabs{display:flex;gap:8px;padding:8px;border-radius:12px;margin-bottom:12px}
  .tab{flex:1;text-align:center;padding:14px;border-radius:12px;cursor:pointer;background:var(--glass);color:#cfe6ff;font-weight:700}
  .tab.active{background:rgba(255,255,255,0.06);color:#fff}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:14px;align-items:start}
  .field{background:var(--card);padding:12px;border-radius:10px;border:1px solid var(--border);color:var(--muted);margin-bottom:10px}
  label{display:block;font-size:13px;margin-bottom:8px;color:rgba(255,255,255,0.9)}
  input[type="text"], input[type="date"], input[type="file"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
  iframe#pdfPreview{width:100%;height:300px;border-radius:10px;border:0;background:#fff;display:none}
  .qr-area{display:flex;gap:12px;align-items:center;flex-direction:column}
  .qr-badge{padding:12px;background:#0b1b2b;border-radius:12px;border:1px solid rgba(255,255,255,0.035);box-shadow:0 10px 20px rgba(0,0,0,0.45)}
  canvas.qr{background:#fff;border-radius:10px;padding:8px;display:block}
  .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .controls .btn{font-size:14px;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,0.06);color:#fff}
  .issued-list{margin-top:12px;max-height:260px;overflow:auto;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02)}
  .issued-item{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
  .mini{font-size:12px;color:rgba(255,255,255,0.75)}
  #reader{width:100%;max-width:420px;margin-top:12px;border-radius:8px;overflow:hidden;background:#07121a}
  .flex{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  footer{text-align:center;margin-top:14px;color:rgba(255,255,255,0.6);font-size:13px}
  @media (max-width:960px){ .grid{grid-template-columns:1fr} iframe#pdfPreview{height:220px} }
</style>
</head>
<body>

<header>
  <h1>Certificate Registry DApp ‚Äî Pro</h1>
  <div class="subtitle">Issue ‚Ä¢ Verify ‚Ä¢ Revoke ‚Ä¢ Scan ‚Ä¢ Share ‚Äî all-in-one</div>

  <div class="top-controls">
    <button id="connectButton" class="btn btn-yellow">üîó Connect Wallet</button>
    <button id="themeToggle" class="btn btn-pill">üåó Theme</button>
  </div>

  <div id="walletStatus" class="status">üß≠ Wallet not connected</div>
</header>

<main>
  <div class="card">
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="issue">Issue</div>
      <div class="tab" data-tab="verify">Verify</div>
      <div class="tab" data-tab="revoke">Revoke</div>
    </div>

    <div class="grid">
      <!-- LEFT: forms -->
      <div>
        <!-- ISSUE -->
        <div id="panel-issue" class="panel">
          <div class="field">
            <label>Upload Certificate (PDF) ‚Äî preview & hash</label>
            <input id="fileInput" type="file" accept="application/pdf" />
            <iframe id="pdfPreview" src=""></iframe>
            <div style="margin-top:10px" class="flex">
              <button id="generateHash" class="btn">üìÑ Generate Hash</button>
              <button id="issueCert" class="btn" style="background:var(--accent-yellow);color:#072;font-weight:800">‚úÖ Issue On-Chain</button>
              <div class="right mini" id="issueStatus"></div>
            </div>
          </div>

          <div class="field" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
            <div><label>Student Name</label><input id="studentName" type="text" placeholder="e.g., A. Sharma" /></div>
            <div><label>Course / Program</label><input id="courseName" type="text" placeholder="e.g., Blockchain Fundamentals" /></div>
            <div><label>Institution</label><input id="institution" type="text" placeholder="e.g., ABC Institute" /></div>
            <div><label>Grade (0-100)</label><input id="grade" type="text" placeholder="e.g., 85" /></div>
            <div><label>Issue Date</label><input id="issueDate" type="date" /></div>
          </div>

          <div class="field">
            <label>Certificate Hash (0x...)</label>
            <input id="hashInput" type="text" placeholder="0x..." />
            <div class="controls">
              <button id="copyLink" class="btn">üìã Copy Verify Link</button>
              <button id="downloadQR" class="btn">‚¨áÔ∏è Download QR</button>
              <button id="shareQR" class="btn">üì§ Share QR</button>
            </div>
          </div>

          <div class="field">
            <strong style="color:#fff">üìù Issued (local)</strong>
            <div id="issuedList" class="issued-list mini"></div>
          </div>
        </div>

        <!-- VERIFY -->
        <div id="panel-verify" class="panel" style="display:none">
          <div class="field">
            <label>Enter or Scan Certificate Hash</label>
            <input id="verifyHash" type="text" placeholder="0x..." />
            <div style="margin-top:10px" class="flex">
              <button id="verifyBtn" class="btn">üîç Verify On-Chain</button>
              <button id="startScan" class="btn">üì∑ Start Scan</button>
              <button id="stopScan" class="btn" disabled>üõë Stop</button>
              <div class="right mini" id="verifyStatus"></div>
            </div>
            <div id="reader"></div>
            <div id="verifyResult" class="mini" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- REVOKE -->
        <div id="panel-revoke" class="panel" style="display:none">
          <div class="field">
            <label>Certificate Hash to Revoke</label>
            <input id="revokeHash" type="text" placeholder="0x..." />
            <div style="margin-top:10px" class="flex">
              <button id="revokeBtn" class="btn" style="background:var(--danger);color:#fff">‚ùå Revoke On-Chain</button>
              <div class="right mini" id="revokeStatus"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: QR + info -->
      <div>
        <div class="qr-area">
          <div class="qr-badge">
            <canvas id="qrCanvas" class="qr" width="220" height="220"></canvas>
          </div>

          <div style="width:100%" class="mini">
            <div style="display:flex;gap:8px">
              <div style="flex:1"><strong style="color:#fff">Quick Actions</strong></div>
              <div style="flex:1;text-align:right" id="networkLabel" class="mini"></div>
            </div>

            <div style="margin-top:10px" class="mini">
              Generate a PDF hash, then Issue (writes hash on-chain). Verify reads certificate details from chain. Revoke marks it revoked on-chain.
            </div>
          </div>
        </div>
      </div>
    </div> <!-- grid -->
  </div> <!-- card -->

  <footer>
    <div class="mini">Tip: Save as <code>index.html</code>, open in Chrome, allow camera & wallet. Contract address is embedded.</div>
  </footer>
</main>

<script>
/* =========================
   CONTRACT (user-provided)
   ========================= */
const contractAddress = "0x2C75F16E20543741578D8066bbcC78cc9BD9d7d1";
const abi = [
	{
		"inputs": [
			{"internalType":"bytes32[]","name":"certHashes","type":"bytes32[]"},
			{"internalType":"string[]","name":"recipientNames","type":"string[]"},
			{"internalType":"string[]","name":"courseTitles","type":"string[]"},
			{"internalType":"uint8[]","name":"grades","type":"uint8[]"},
			{"internalType":"string[]","name":"_ipfsCids","type":"string[]"}
		],
		"name":"batchIssueCertificates","outputs":[],"stateMutability":"nonpayable","type":"function"
	},
	{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
	{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},
	{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"certHash","type":"bytes32"},{"indexed":true,"internalType":"address","name":"issuer","type":"address"},{"indexed":false,"internalType":"string","name":"recipientName","type":"string"},{"indexed":false,"internalType":"string","name":"courseTitle","type":"string"},{"indexed":false,"internalType":"string","name":"ipfsCid","type":"string"}],"name":"CertificateIssued","type":"event"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"certHash","type":"bytes32"},{"indexed":true,"internalType":"address","name":"issuer","type":"address"}],"name":"CertificateRevoked","type":"event"},
	{"inputs":[{"internalType":"address","name":"_account","type":"address"}],"name":"grantIssuerRole","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"bytes32","name":"certHash","type":"bytes32"},{"internalType":"string","name":"recipientName","type":"string"},{"internalType":"string","name":"courseTitle","type":"string"},{"internalType":"uint8","name":"grade","type":"uint8"},{"internalType":"string","name":"_ipfsCid","type":"string"}],"name":"issueCertificate","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"}],"name":"IssuerGranted","type":"event"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"}],"name":"IssuerRevoked","type":"event"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
	{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"bytes32","name":"certHash","type":"bytes32"}],"name":"revokeCertificate","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"address","name":"_account","type":"address"}],"name":"revokeIssuerRole","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"bytes32","name":"certHash","type":"bytes32"}],"name":"getCertificateDetails","outputs":[{"components":[{"internalType":"address","name":"issuer","type":"address"},{"internalType":"uint256","name":"issueDate","type":"uint256"},{"internalType":"bool","name":"isValid","type":"bool"},{"internalType":"string","name":"recipientName","type":"string"},{"internalType":"string","name":"courseTitle","type":"string"},{"internalType":"uint8","name":"grade","type":"uint8"},{"internalType":"string","name":"ipfsCid","type":"string"}],"internalType":"struct CertificateRegistryV2.Certificate","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"address","name":"_issuer","type":"address"}],"name":"getCertificatesByIssuer","outputs":[{"internalType":"bytes32[]","name":"","type":"bytes32[]"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isIssuer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}
];

/* =========================
   STATE & HELPERS
   ========================= */
let web3, contract, account;
const LS_KEY = 'certs_v2_onchain';
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function setWalletStatus(text){ $('#walletStatus').innerText = text; }
function setMini(id, txt){ const el = document.getElementById(id); if(el) el.innerText = txt; }

/* =========================
   THEME
   ========================= */
const themeToggle = $('#themeToggle');
(function initTheme(){ const p = localStorage.getItem('dapp_theme') || 'dark'; if(p === 'light') document.documentElement.classList.add('light'); })();
themeToggle.addEventListener('click', ()=>{ document.documentElement.classList.toggle('light'); localStorage.setItem('dapp_theme', document.documentElement.classList.contains('light') ? 'light' : 'dark'); });

/* =========================
   TABS
   ========================= */
$$('.tab').forEach(tab => tab.addEventListener('click', () => {
  $$('.tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  const key = tab.dataset.tab;
  $$('.panel').forEach(p=>p.style.display='none');
  document.getElementById('panel-' + key).style.display = 'block';
}));

/* =========================
   CONNECT WALLET
   ========================= */
$('#connectButton').addEventListener('click', async () => {
  if(!window.ethereum){ alert('Please install MetaMask'); return; }
  try {
    web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    const accounts = await web3.eth.getAccounts();
    account = accounts[0];
    contract = new web3.eth.Contract(abi, contractAddress);
    $('#connectButton').innerText = '‚úÖ Connected';
    setWalletStatus('üü¢ Connected: ' + account);
    const netId = await web3.eth.net.getId();
    $('#networkLabel').innerText = 'Network: ' + netId;
    window.ethereum.on('accountsChanged', accs => { account = accs[0]; setWalletStatus('üü¢ Connected: ' + account); });
    window.ethereum.on('chainChanged', ()=> location.reload());
    renderIssued();
  } catch(e){ alert('Wallet connect failed: ' + (e.message || e)); }
});

/* =========================
   FILE PREVIEW & SHA-256
   ========================= */
$('#generateHash').addEventListener('click', async () => {
  const file = $('#fileInput').files[0];
  if(!file) return alert('Please select a PDF file first');
  try {
    const url = URL.createObjectURL(file);
    $('#pdfPreview').src = url; $('#pdfPreview').style.display = 'block';

    const ab = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', ab);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hex = '0x' + hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
    $('#hashInput').value = hex;
    drawQRCode(hex);
    setMini('issueStatus', 'Hash generated');
  } catch(e){ alert('Hash generation error: ' + (e.message || e)); }
});

/* =========================
   QR DRAW
   ========================= */
function drawQRCode(text){
  if(!text) return;
  QRCode.toCanvas($('#qrCanvas'), text, { width:220, margin:1 }, err => { if(err) console.error(err); });
}

/* mirror hash input */
$('#hashInput').addEventListener('input', (e) => {
  const v = e.target.value.trim();
  if(/^0x[0-9a-fA-F]{64}$/.test(v)){ drawQRCode(v); $('#verifyHash').value = v; $('#revokeHash').value = v; }
});

/* =========================
   LOCAL STORAGE: save & render
   ========================= */
function getIssued(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{return []} }
function saveIssued(entry){ const l=getIssued(); l.unshift(entry); localStorage.setItem(LS_KEY, JSON.stringify(l.slice(0,500))); }
function renderIssued(){
  const container = $('#issuedList'); const items = getIssued();
  if(!items.length){ container.innerHTML = '<div class="mini">No local issued records yet</div>'; return; }
  container.innerHTML = '';
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='issued-item';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong style="color:#fff">${it.name||'‚Äî'}</strong><div class="mini">${it.course||'‚Äî'} ‚Ä¢ ${it.institution||'‚Äî'}</div></div><div class="mini">${new Date(it.ts||Date.now()).toLocaleString()}</div></div>
      <div class="mini" style="margin-top:8px;word-break:break-all">${it.hash}</div>
      <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" data-act="copy" data-h="${it.hash}">Copy Link</button><button class="btn" data-act="qr" data-h="${it.hash}">Show QR</button><button class="btn" data-act="verify" data-h="${it.hash}">Verify</button></div>
      <div class="mini" style="margin-top:8px">${it.txHash?('tx:'+it.txHash):''}${it.revoked?(' ‚Ä¢ REVOKED'):''}</div>`;
    container.appendChild(div);
  });
  container.querySelectorAll('button').forEach(b=>b.onclick = ev=>{
    const act = ev.currentTarget.dataset.act, h = ev.currentTarget.dataset.h;
    if(act==='copy'){ navigator.clipboard.writeText(buildVerifyURL(h)); alert('Link copied'); }
    else if(act==='qr'){ $('#hashInput').value = h; drawQRCode(h); }
    else if(act==='verify'){ $('#verifyHash').value = h; $$('.tab').forEach(t=>t.classList.remove('active')); document.querySelector('.tab[data-tab=\"verify\"]').classList.add('active'); $$('.panel').forEach(p=>p.style.display='none'); document.getElementById('panel-verify').style.display='block'; $('#verifyBtn').click(); }
  });
}

/* =========================
   ISSUE ON-CHAIN (issueCertificate)
   ABI: (bytes32 certHash, string recipientName, string courseTitle, uint8 grade, string _ipfsCid)
   We'll pass empty string for ipfsCid.
   ========================= */
$('#issueCert').addEventListener('click', async () => {
  if(!contract || !account) return alert('Connect wallet first');
  const hash = $('#hashInput').value.trim();
  if(!/^0x[0-9a-fA-F]{64}$/.test(hash)) return alert('Hash must be 0x + 64 hex chars (generate from PDF).');
  const recipientName = $('#studentName').value.trim() || '‚Äî';
  const courseTitle = $('#courseName').value.trim() || '‚Äî';
  let grade = parseInt($('#grade').value,10); if(Number.isNaN(grade) || grade < 0) grade = 0; if(grade > 255) grade = 255;
  try {
    setMini('issueStatus','Sending tx...');
    const gas = await contract.methods.issueCertificate(hash, recipientName, courseTitle, grade, "").estimateGas({ from: account });
    const tx = await contract.methods.issueCertificate(hash, recipientName, courseTitle, grade, "").send({ from: account, gas: Math.floor(gas*1.2) });
    const meta = { hash, name: recipientName, course: courseTitle, institution: $('#institution').value.trim()||'‚Äî', grade, ts: Date.now(), txHash: tx.transactionHash };
    saveIssued(meta); renderIssued(); drawQRCode(hash);
    setMini('issueStatus','Issued: ' + tx.transactionHash);
    setWalletStatus('Last tx: ' + tx.transactionHash);
  } catch(e){ alert('Issue failed: ' + (e.message || e)); setMini('issueStatus','Error'); }
});

/* =========================
   VERIFY: getCertificateDetails(certHash) -> tuple
   { issuer, issueDate, isValid, recipientName, courseTitle, grade, ipfsCid }
   ========================= */
$('#verifyBtn').addEventListener('click', async () => {
  if(!contract) return alert('Connect wallet (to call node)');
  const hash = $('#verifyHash').value.trim();
  if(!/^0x[0-9a-fA-F]{64}$/.test(hash)) return alert('Enter a 0x + 64 hex hash');
  try {
    setMini('verifyStatus','Checking...');
    const details = await contract.methods.getCertificateDetails(hash).call();
    // details is a tuple - safe-check fields
    const issuer = details.issuer || details[0];
    const issueDate = parseInt(details.issueDate || details[1] || 0, 10);
    const isValid = (details.isValid !== undefined) ? details.isValid : details[2];
    const recipientName = details.recipientName || details[3] || '';
    const courseTitle = details.courseTitle || details[4] || '';
    const grade = details.grade !== undefined ? details.grade : details[5];
    const ipfsCid = details.ipfsCid || details[6] || '';
    // show nicely
    const validText = isValid ? '‚úÖ VALID' : '‚ùå NOT VALID';
    const issueWhen = issueDate ? new Date(issueDate * 1000).toLocaleString() : '‚Äî';
    $('#verifyResult').innerText = `${validText}\nIssuer: ${issuer}\nIssued: ${issueWhen}\nRecipient: ${recipientName}\nCourse: ${courseTitle}\nGrade: ${grade}\nIPFS CID: ${ipfsCid}`;
    setMini('verifyStatus','Done');
  } catch(e){ alert('Verify failed: ' + (e.message || e)); setMini('verifyStatus','Error'); }
});

/* =========================
   REVOKE: revokeCertificate(certHash)
   ========================= */
$('#revokeBtn').addEventListener('click', async () => {
  if(!contract || !account) return alert('Connect wallet first');
  const hash = $('#revokeHash').value.trim();
  if(!/^0x[0-9a-fA-F]{64}$/.test(hash)) return alert('Enter 0x + 64 hex chars');
  try {
    setMini('revokeStatus','Sending revoke tx...');
    const gas = await contract.methods.revokeCertificate(hash).estimateGas({ from: account });
    const tx = await contract.methods.revokeCertificate(hash).send({ from: account, gas: Math.floor(gas*1.2) });
    // mark locally if present
    const list = getIssued(); const idx = list.findIndex(i=>i.hash===hash); if(idx>-1){ list[idx].revoked = true; list[idx].revokeTx = tx.transactionHash; localStorage.setItem(LS_KEY, JSON.stringify(list)); }
    renderIssued();
    setMini('revokeStatus','Revoked: ' + tx.transactionHash);
  } catch(e){ alert('Revoke failed: ' + (e.message || e)); setMini('revokeStatus','Error'); }
});

/* =========================
   QR share/copy/download helpers
   ========================= */
function buildVerifyURL(hash){ return location.origin + location.pathname + '?certHash=' + encodeURIComponent(hash); }
$('#copyLink').addEventListener('click', ()=>{ const h = $('#hashInput').value.trim(); if(!h) return alert('No hash'); navigator.clipboard.writeText(buildVerifyURL(h)); alert('Link copied'); });
$('#downloadQR').addEventListener('click', ()=>{ const c = $('#qrCanvas'); const a = document.createElement('a'); a.download='certificate_qr.png'; a.href = c.toDataURL('image/png'); a.click(); });
$('#shareQR').addEventListener('click', ()=>{ const c = $('#qrCanvas'); c.toBlob(async blob => { const file = new File([blob],'certificate_qr.png',{type:'image/png'}); if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file], title:'Certificate QR'}); } else alert('Sharing not supported'); }); });

/* =========================
   QR scanning (html5-qrcode)
   ========================= */
let html5QrCode = null;
$('#startScan').addEventListener('click', async ()=> {
  if(html5QrCode) return;
  html5QrCode = new Html5Qrcode("reader");
  try {
    const cams = await Html5Qrcode.getCameras();
    const camId = cams && cams.length ? cams[0].id : null;
    await html5QrCode.start(camId, { fps: 10, qrbox: 250 }, decoded => {
      $('#verifyHash').value = decoded;
      $('#verifyBtn').click();
      html5QrCode.stop().then(()=>{ html5QrCode = null; $('#stopScan').disabled = true; }).catch(()=>{});
    }, err => {});
    $('#stopScan').disabled = false;
  } catch(e){ alert('Camera start failed: ' + (e.message || e)); html5QrCode = null; $('#stopScan').disabled = true; }
});
$('#stopScan').addEventListener('click', async ()=>{ if(!html5QrCode) return; try{ await html5QrCode.stop(); html5QrCode = null; $('#stopScan').disabled = true; }catch(e){ console.warn(e); } });

/* =========================
   Deep link auto verify
   ========================= */
(function autoVerifyFromURL(){
  const p = new URLSearchParams(location.search); const h = p.get('certHash');
  if(h){ $$('.tab').forEach(t=>t.classList.remove('active')); document.querySelector('.tab[data-tab=\"verify\"]').classList.add('active'); $$('.panel').forEach(pn=>pn.style.display='none'); document.getElementById('panel-verify').style.display='block'; $('#verifyHash').value = h; setTimeout(()=>{ $('#verifyBtn').click(); }, 700); drawQRCode(h); }
})();

/* =========================
   Init local & blank QR
   ========================= */
renderIssued();
drawQRCode('Certificate Registry DApp');

</script>
</body>
</html>
